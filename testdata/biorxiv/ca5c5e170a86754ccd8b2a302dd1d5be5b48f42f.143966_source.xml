<article article-type="article" specific-use="production" xml:lang="en" xmlns:hw="org.highwire.hpp" xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:ref="http://schema.highwire.org/Reference" xmlns:hwp="http://schema.highwire.org/Journal" xmlns:l="http://schema.highwire.org/Linking" xmlns:r="http://schema.highwire.org/Revision" xmlns:x="http://www.w3.org/1999/xhtml" xmlns:app="http://www.w3.org/2007/app" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:nlm="http://schema.highwire.org/NLM/Journal" xmlns:a="http://www.w3.org/2005/Atom" xmlns:c="http://schema.highwire.org/Compound" xmlns:hpp="http://schema.highwire.org/Publishing"><front><journal-meta><journal-id journal-id-type="hwp">biorxiv</journal-id><journal-id journal-id-type="publisher-id">BIORXIV</journal-id><journal-title>bioRxiv</journal-title><abbrev-journal-title abbrev-type="publisher">bioRxiv</abbrev-journal-title><publisher><publisher-name>Cold Spring Harbor Laboratory</publisher-name></publisher></journal-meta><article-meta><article-id pub-id-type="doi">10.1101/143966</article-id><article-id pub-id-type="other" hwp:sub-type="pisa">biorxiv;143966v1</article-id><article-id pub-id-type="other" hwp:sub-type="pisa-master">biorxiv;143966</article-id><article-id pub-id-type="other" hwp:sub-type="slug">143966</article-id><article-id pub-id-type="other" hwp:sub-type="tag">143966</article-id><article-version>1.1</article-version><article-categories><subj-group subj-group-type="author-type"><subject>Regular Article</subject></subj-group><subj-group subj-group-type="heading"><subject>New Results</subject></subj-group><subj-group subj-group-type="hwp-journal-coll" hwp:journal-coll-id="Systems Biology" hwp:journal="biorxiv"><subject>Systems Biology</subject></subj-group></article-categories><title-group><article-title hwp:id="article-title-1">High-throughput, image-based screening of genetic variant libraries</article-title></title-group><author-notes hwp:id="author-notes-1"><corresp id="cor1" hwp:id="corresp-1">Correspondence to <email hwp:id="email-1">zhuang@chemistry.harvard.edu</email></corresp></author-notes><contrib-group hwp:id="contrib-group-1"><contrib contrib-type="author" hwp:id="contrib-1"><name name-style="western" hwp:sortable="Emanuel George"><surname>Emanuel</surname><given-names>George</given-names></name><xref ref-type="aff" rid="a1" hwp:id="xref-aff-1-1" hwp:rel-id="aff-1">1</xref><xref ref-type="aff" rid="a2" hwp:id="xref-aff-2-1" hwp:rel-id="aff-2">2</xref><xref ref-type="aff" rid="a3" hwp:id="xref-aff-3-1" hwp:rel-id="aff-3">3</xref></contrib><contrib contrib-type="author" hwp:id="contrib-2"><name name-style="western" hwp:sortable="Moffitt Jeffrey R."><surname>Moffitt</surname><given-names>Jeffrey R.</given-names></name><xref ref-type="aff" rid="a1" hwp:id="xref-aff-1-2" hwp:rel-id="aff-1">1</xref><xref ref-type="aff" rid="a3" hwp:id="xref-aff-3-2" hwp:rel-id="aff-3">3</xref></contrib><contrib contrib-type="author" corresp="yes" hwp:id="contrib-3"><name name-style="western" hwp:sortable="Zhuang Xiaowei"><surname>Zhuang</surname><given-names>Xiaowei</given-names></name><xref ref-type="aff" rid="a1" hwp:id="xref-aff-1-3" hwp:rel-id="aff-1">1</xref><xref ref-type="aff" rid="a3" hwp:id="xref-aff-3-3" hwp:rel-id="aff-3">3</xref><xref ref-type="aff" rid="a4" hwp:id="xref-aff-4-1" hwp:rel-id="aff-4">4</xref></contrib><aff id="a1" hwp:id="aff-1" hwp:rev-id="xref-aff-1-1 xref-aff-1-2 xref-aff-1-3"><label>1</label><institution hwp:id="institution-1">Howard Hughes Medical Institute</institution>, Cambridge, MA 02138, <country>USA</country></aff><aff id="a2" hwp:id="aff-2" hwp:rev-id="xref-aff-2-1"><label>2</label><institution hwp:id="institution-2">Graduate Program in Biophysics</institution>, Cambridge, MA 02138, <country>USA</country></aff><aff id="a3" hwp:id="aff-3" hwp:rev-id="xref-aff-3-1 xref-aff-3-2 xref-aff-3-3"><label>3</label><institution hwp:id="institution-3">Department of Chemistry and Chemical Biology</institution>, Cambridge, MA 02138, <country>USA</country></aff><aff id="a4" hwp:id="aff-4" hwp:rev-id="xref-aff-4-1"><label>4</label><institution hwp:id="institution-4">Department of Physics, Harvard University</institution>, Cambridge, MA 02138, <country>USA</country></aff></contrib-group><pub-date pub-type="epub-original" hwp:start="2017"><year>2017</year></pub-date><pub-date pub-type="hwp-created" hwp:start="2017-05-30T12:29:42-07:00">
    <day>30</day><month>5</month><year>2017</year>
  </pub-date><pub-date pub-type="hwp-received" hwp:start="2017-05-30T12:29:42-07:00">
    <day>30</day><month>5</month><year>2017</year>
  </pub-date><pub-date pub-type="epub" hwp:start="2017-05-30T12:42:53-07:00">
    <day>30</day><month>5</month><year>2017</year>
  </pub-date><pub-date pub-type="epub-version" hwp:start="2017-05-30T12:42:53-07:00">
    <day>30</day><month>5</month><year>2017</year>
  </pub-date><elocation-id>143966</elocation-id><history hwp:id="history-1">
<date date-type="received" hwp:start="2017-05-30"><day>30</day><month>5</month><year>2017</year></date>
<date date-type="accepted" hwp:start="2017-05-30"><day>30</day><month>5</month><year>2017</year></date>
</history><permissions><copyright-statement hwp:id="copyright-statement-1">© 2017, Posted by Cold Spring Harbor Laboratory</copyright-statement><copyright-year>2017</copyright-year><license hwp:id="license-1"><p hwp:id="p-1">The copyright holder for this pre-print is the author. All rights reserved. The material may not be redistributed, re-used or adapted without the author's permission.</p></license></permissions><self-uri xlink:href="143966.pdf" content-type="pdf" xlink:role="full-text"/><self-uri l:ref="forthcoming:yes" c:role="http://schema.highwire.org/variant/abstract" xlink:role="abstract" content-type="xhtml+xml" hwp:variant="yes"/><self-uri l:ref="forthcoming:yes" c:role="http://schema.highwire.org/variant/full-text" xlink:href="file:/content/biorxiv/vol0/issue2019/pdf/143966v1.pdf" hwp:variant="yes" content-type="pdf" xlink:role="full-text"/><self-uri l:ref="forthcoming:yes" c:role="http://schema.highwire.org/variant/full-text" xlink:role="full-text" content-type="xhtml+xml" hwp:variant="yes"/><self-uri l:ref="forthcoming:yes" c:role="http://schema.highwire.org/variant/source" xlink:role="source" content-type="xml" xlink:show="none" hwp:variant="yes"/><self-uri l:ref="forthcoming:yes" c:role="http://schema.highwire.org/variant/original" xlink:role="original" content-type="xml" xlink:show="none" hwp:variant="yes" xlink:href="143966.xml"/><self-uri content-type="abstract" xlink:href="file:/content/biorxiv/vol0/issue2019/abstracts/143966v1/143966v1.htslp"/><self-uri content-type="fulltext" xlink:href="file:/content/biorxiv/vol0/issue2019/fulltext/143966v1/143966v1.htslp"/><abstract hwp:id="abstract-1"><title hwp:id="title-1">Abstract</title><p hwp:id="p-2">Image-based, high-throughput, high-content screening of pooled libraries of genetic perturbations will greatly advance our understanding biological systems and facilitate many biotechnology applications. Here we introduce a high-throughput screening method that allows highly diverse genotypes and the corresponding phenotypes to be imaged in numerous individual cells. To facilitate genotyping by imaging, barcoded genetic variants are introduced into the cells, each cell carrying a single genetic variant connected to a unique, nucleic-acid barcode. To identify the genotype-phenotype correspondence, we perform live-cell imaging to determine the phenotype of each cell, and massively multiplexed FISH imaging to measure the barcode expressed in the same cell. We demonstrated the utility of this approach by screening for brighter and more photostable variants of the fluorescent protein YFAST. We imaged 20 million cells expressing ~60,000 YFAST mutants and identified novel YFAST variants that are substantially brighter and/or more photostable than the wild-type protein.</p></abstract><counts><page-count count="18"/></counts></article-meta></front><body><p hwp:id="p-3">High-throughput screening of genetic perturbations is playing an increasingly important role in advancing biology and biotechnology. For example, by observing the effects of a large number of amino acid changes within a selected protein, large-scale screening can enable efficient searches for fluorescent proteins better adapted for bioimaging or protein and nucleic acid drugs with desired therapeutic properties. It can also enable the examination of how mutations of a protein affect cell function or physiology. Since each cell is composed of many genes, large-throughput screening can also allow the effects of inhibition or activation of individual genes or combinations of genes to be tested at the genomic scale, which will help decipher the effects of genes and gene networks on cellular behaviors.</p><p hwp:id="p-4">Large-scale screening efforts are greatly facilitated by pooled, high-diversity libraries of genetic perturbations because of the ease and scalability associated with the construction of these pools. By using methods such as error-prone PCR<sup><xref ref-type="bibr" rid="c1" hwp:id="xref-ref-1-1" hwp:rel-id="ref-1">1</xref></sup> or cloning with large, defined pools of array-synthesized oligonucleotides<sup><xref ref-type="bibr" rid="c2" hwp:id="xref-ref-2-1" hwp:rel-id="ref-2">2</xref></sup>, it is often possible to create pooled libraries with a very large number of genetic variants or perturbations using a similar degree of effort as required to make any individual library member. The screening of pooled libraries then depends critically on the ability to measure not only the desired phenotype but also the genotype of the corresponding library members. The measured phenotypes can be simple in some cases, such as protein affinity as measured by standard pull-down assays<sup><xref ref-type="bibr" rid="c3" hwp:id="xref-ref-3-1" hwp:rel-id="ref-3">3</xref>,<xref ref-type="bibr" rid="c4" hwp:id="xref-ref-4-1" hwp:rel-id="ref-4">4</xref></sup>, or cellular fluorescence as determined by FACS<sup><xref ref-type="bibr" rid="c5" hwp:id="xref-ref-5-1" hwp:rel-id="ref-5">5</xref></sup>, and in both cases, the genotype can be determined via sorting or enriching library members with the desired phenotype followed by techniques such as sequencing to determine the genotype. However, there are many phenotypes that cannot be quantified with these techniques. Phenotypes ranging from cellular morphology and dynamics to the intracellular organization of different cellular components require high-resolution, time-lapse optical microscopy to be measured. Unfortunately, it has proven challenging to combine pooled library screening with high-resolution optical microscopy because it is difficult to isolate or recover individual library members based on their imaged phenotype and then determine their genotype. If, however, one had the ability to measure the genotype of individual library members also by imaging, then library member isolation and recovery would not be required, making it possible to combine the ease and scalability of pooled library screening with imaging-based phenotype measurements.</p><p hwp:id="p-5">Here we report a novel high-throughput, imaging-based screening method that allows the characterization of both phenotype and genotype for pooled populations of genetically diverse cells. In this method, we associate each genetic variant with a unique barcode composed of a series of short oligonucleotide hybridization sites. After introducing the barcoded genetic variant library into a population of cells and measuring phenotypes with imaging, the cells are fixed and the barcodes are determined using multiplexed error robust fluorescence in situ hybridization (MERFISH), a method that utilizes combinatorial labeling and sequential imaging to identify a large number of barcodes<sup><xref ref-type="bibr" rid="c6" hwp:id="xref-ref-6-1" hwp:rel-id="ref-6">6</xref></sup>. We tested the feasibility and quantified the accuracy of this screening approach by screening a library of 1.5 million cells with 80,000 unique barcodes in which cells either did or did not express the fluorescent protein mMaple3<sup><xref ref-type="bibr" rid="c7" hwp:id="xref-ref-7-1" hwp:rel-id="ref-7">7</xref></sup>. Based on these measurements, we estimated that our genotype misidentification rate is less than 1% for individual cells. To demonstrate the power of this approach, we utilized it to improve the brightness and photostability of YFAST, a recently developed fluorescent protein that becomes fluorescent upon binding to an exogenous chromophore<sup><xref ref-type="bibr" rid="c8" hwp:id="xref-ref-8-1" hwp:rel-id="ref-8">8</xref></sup>. With this approach, we efficiently screened 20 million <italic toggle="yes">E. coli</italic> cells containing ~160,000 unique barcodes and ~60,000 unique YFAST mutants, which resulted in the identification of YFAST variant with substantially increased brightness and photostability. By utilizing high-resolution imaging, we envision that this approach also has the potential to screen the effect of genetic perturbations on other cellular properties that would be difficult to measure with non-imaging methods, such as the morphology and dynamics of the cell, or the intracellular distributions of proteins/RNAs and the spatial organization of the genome.</p><p hwp:id="p-6">In our previous demonstration of MERFISH<sup><xref ref-type="bibr" rid="c6" hwp:id="xref-ref-6-2" hwp:rel-id="ref-6">6</xref></sup>, we utilized this approach to massively increase the multiplexing of single-molecule fluorescence in situ hybridization<sup><xref ref-type="bibr" rid="c9" hwp:id="xref-ref-9-1" hwp:rel-id="ref-9">9</xref>,<xref ref-type="bibr" rid="c10" hwp:id="xref-ref-10-1" hwp:rel-id="ref-10">10</xref></sup> and measure a large number of distinct RNA species simultaneously in single cells<sup><xref ref-type="bibr" rid="c6" hwp:id="xref-ref-6-3" hwp:rel-id="ref-6">6</xref></sup>. We subsequently improved the throughput of MERFISH to allow a large number of cells to be measured in a short period of time<sup><xref ref-type="bibr" rid="c11" hwp:id="xref-ref-11-1" hwp:rel-id="ref-11">11</xref></sup>. Here we reasoned that we could use this approach to identify the genotype of individual cells if each cell contains a unique DNA barcode that is associated with the gene variant of interest. Thus, cells could be identified by effectively measuring the identity of the RNA that it expressed from the barcode. To construct such barcodes, we designed nucleotide sequences that contain a concatenation of a fixed number of hybridization sites, where the sequence of each hybridization site was one of a pair of unique sequences associated with that site (<xref rid="fig1" ref-type="fig" hwp:id="xref-fig-1-1" hwp:rel-id="F1">Fig. 1A</xref>). We term these sequences readout sequences. Effectively each barcode sequence can be thought of as representing an N-bit binary code, where there is a unique readout sequence to represent a “1” or a “0” in each bit. Thus, each barcode is comprised of a set of <italic toggle="yes">N</italic> hybridization sites drawn from 2N unique readout sequences: readout sequence 1-0, readout sequence 1-1, readout sequence 2-0, readout sequence 2-1, …, readout sequence <italic toggle="yes">N</italic>-0, readout sequence <italic toggle="yes">N</italic>-1. For example, a barcode sequence corresponding to the binary word 101…1 would consist of readout sequence 1-1, followed by readout sequence 2-0, then readout sequence 3-1, …, and finally readout sequence <italic toggle="yes">N</italic>-1. A similar approach could be used to construct alternative barcodes using more unique readout sequences at each site, i.e. three sites would correspond to a ternary code, or using the absence of a site as a measurable signal, i.e. a ‘1’ could be the presence of a site while a ‘0’ could be represented by its absence.</p><fig id="fig1" position="float" orientation="portrait" fig-type="figure" hwp:id="F1" hwp:rev-id="xref-fig-1-1 xref-fig-1-2 xref-fig-1-3"><object-id pub-id-type="other" hwp:sub-type="pisa">biorxiv;143966v1/FIG1</object-id><object-id pub-id-type="other" hwp:sub-type="slug">F1</object-id><object-id pub-id-type="publisher-id">fig1</object-id><label>Fig. 1.</label><caption hwp:id="caption-1"><title hwp:id="title-2">A high-through, image-based screening method using massively multiplexed fluorescence in situ hybridization.</title><p hwp:id="p-7">(A) Schematic depiction of an RNA barcode. Each RNA barcode consists of the concatenation of a series of hybridization sequences, each of which can be associated with a different bit in an <italic toggle="yes">N</italic>-bit binary barcode. Each hybridization sequence can utilize one of two readout sequences unique to that position, with one readout sequence associated with a “1” at that bit and another with a “0”. (B) Schematic depiction of library construction. The library of barcodes is merged with a library of genetic variants and transformed into bacteria. The correspondence between the barcodes and genetic variants is determined by sequencing. (C) Schematic diagram of the image-based phenotype-genotype characterization. The phenotype is first characterized in surface-adhered cells. Then, the cells are fixed, and multiple rounds of hybridization are used to measure the barcodes. During the first round, readout probe 1-0 is added and cells with barcodes that read “0” in the first bit, i.e. which contain the readout sequence 1-0, should bind to the probe and become fluorescent, whereas cells with barcodes that read “1” in the first bit should remain dark. Once readout probe 1-0 is extinguished, readout probe 1-1 is added and the cells with barcodes that read “1” in the first bit, which contain the readout sequence 1-1, should become fluorescent. This difference in fluorescence intensity allows the value of bit 1 to be determined for each cell. This process is repeated for the remaining bits. After measuring all bits, the barcode is determined, revealing the identity of the genetic variant contained in the cell and linking the measured phenotype to the genotype.</p></caption><graphic xlink:href="143966_fig1" position="float" orientation="portrait" hwp:id="graphic-1"/></fig><p hwp:id="p-8">As an illustration of one way in which this barcoding scheme could be used to identify genetic variants, we created a library of plasmids expressing these N-bit barcodes and a library of plasmids expressing a series of genetic variants of a protein of interest. To create a barcoded library of genetic variants, we fused the barcode sequences and the sequences expressing the genetic variants to create a library of new plasmids, each of which expresses a random combination of a genetic variant and a barcode, and introduced the library into <italic toggle="yes">E. coli</italic> cells such that each cell only expresses one plasmid (<xref rid="fig1" ref-type="fig" hwp:id="xref-fig-1-2" hwp:rel-id="F1">Fig. 1B</xref>) (see Materials and Methods for the details). To reduce the chance of a barcode appearing in the library associated with more than one genetic variant, we bottlenecked the diversity of the barcoded genetic variant library by limiting the number of cells expressing the barcoded genetic variant library to 1 to 10% of the total barcode diversity of 2<sup><italic toggle="yes">N</italic></sup>. We then determined which barcode is associated with which genetic variant by extracting these plasmids and sequencing them with next generation sequencing to construct a look-up table. These measurements also detected a remaining small fraction of barcodes that were each associated with more than one genetic variant. If detected, these barcodes were removed from further analysis.</p><p hwp:id="p-9">To screen this barcoded genetic variant library, we imaged cellular phenotypes while the cells were still alive (<xref rid="fig1" ref-type="fig" hwp:id="xref-fig-1-3" hwp:rel-id="F1">Fig. 1C</xref>). Then, the cells were fixed without removing them from the microscope, and the RNA expressed from the barcodes were read out using multiplexed error-robust fluorescence in situ hybridization (MERFISH)<sup><xref ref-type="bibr" rid="c6" hwp:id="xref-ref-6-4" hwp:rel-id="ref-6">6</xref></sup>.</p><p hwp:id="p-10">During the barcode readout process, multiple hybridization rounds were used and fluorescently labeled readout probes complementary to each readout sequence on the barcode were hybridized in each round to detect which readout sequences are present in which cells. First, readout probe 1-0, complementary to readout sequence 1-0, was introduced so that it can hybridize to cells that contain readout sequence 1-0, namely the cells containing barcodes whose first bit is “1”, causing those cells to become brightly fluorescent. All the cells were imaged and then the fluorescence signal removed from the sample. Then, readout probe 1-1 was hybridized. Since every barcode contains either readout sequence 1-0 or readout sequence 1-1, the cells that did not become fluorescent in the first round should became fluorescent in the second round. The value for bit 1 for each cell was then assigned based on the fluorescence intensity ratio between these two rounds. This process was iterated until all <italic toggle="yes">N</italic> bits were probed. To reduce the number of hybridization rounds, we used multiple color imaging with spectrally distinct fluorescent dyes to probe for the presence of multiple readout sequences simultaneously in each round<sup><xref ref-type="bibr" rid="c11" hwp:id="xref-ref-11-2" hwp:rel-id="ref-11">11</xref></sup>. Three-color imaging was used in this work though a readout scheme using more colors is also possible.</p><p hwp:id="p-11">Since each cell expresses many copies of its corresponding barcode RNA, the fluorescence signal was very bright, and hence the readout error rate for each bit was very small. Thus, we did not find it necessary to use error correcting codes in this case, as we previously used for MERFISH<sup><xref ref-type="bibr" rid="c6" hwp:id="xref-ref-6-5" hwp:rel-id="ref-6">6</xref></sup>, but instead all 2<sup><italic toggle="yes">N</italic></sup> possible barcodes could be used in principle. However, in practice, to avoid a barcode appearing paired with multiple mutants in the same library, we bottlenecked the number of unique library members, as described above. The use of only a subset of barcodes allowed the experimental measurement of the frequency with which unused barcodes were detected, which in turn allowed us to quantify the rate of misidentifying the genotype of a cell, as we describe below. With a constant degree of bottlenecking, this type of internal error measurement and error robustness is maintained even as the number of possible binary barcodes increases exponentially with the number of bits. Thus, this barcoding scheme should allow millions of unique barcodes to be measured with only tens of hybridization rounds.</p><p hwp:id="p-12">To test the accuracy of this screening approach, we created a library containing only two “genetic variants”, the mTagBFP2 gene and the fusion of mTagBFP2 and mMaple3 genes (<xref rid="fig2" ref-type="fig" hwp:id="xref-fig-2-1" hwp:rel-id="F2">Fig. 2A</xref>). Two barcoded libraries were created by merging a 21-bit binary barcode library, consisting of more than 2 million (2<sup>21</sup>) unique barcodes, with the two plasmids (one containing the mTagBFP2 and the other containing mTagBFP2-mMaple3 gene), one for each library, by isothermal assembly. Then, each of these complete libraries was electroporated into <italic toggle="yes">E. coli</italic> cells, and a fixed number of cells were extracted to bottleneck these libraries to ~40,000 unique members. The plasmids were extracted from the cells and sequenced to determine which of the ~2 million possible barcodes were present in each library and, thus, associated with the presence or absence of mMaple3. Sequencing confirmed that in the mixture of the two libraries, ~80,000 unique barcodes were present, as expected, representing 4% of all 2<sup>21</sup> possible barcodes.</p><fig id="fig2" position="float" orientation="portrait" fig-type="figure" hwp:id="F2" hwp:rev-id="xref-fig-2-1 xref-fig-2-2 xref-fig-2-3 xref-fig-2-4 xref-fig-2-5 xref-fig-2-6"><object-id pub-id-type="other" hwp:sub-type="pisa">biorxiv;143966v1/FIG2</object-id><object-id pub-id-type="other" hwp:sub-type="slug">F2</object-id><object-id pub-id-type="publisher-id">fig2</object-id><label>Fig. 2.</label><caption hwp:id="caption-2"><title hwp:id="title-3">Performance characterization of the screening method by measuring 600,000 cells containing 80,000 unique barcodes associated with two known genotypes and phenotypes.</title><p hwp:id="p-13">(A) Schematic diagram of the library constituents. Among the 80,000 distinct 21-bit barcodes, half are associated with the mTagBFP2 gene while the other half are associated with the mTagBFP2-mMaple3 fusion gene. Both sets of cells will express RNA barcodes, but only those expressing mTagBFP2-mMaple3 will be fluorescent in the 560-nm channel. (B) Fluorescent images for each readout from a subset of the full 21 bits. Images after the readout sequence corresponding to a “0” (top) or to a “1” (middle) are hybridized are shown. The difference image (bottom) indicates whether a “0” or “1” is assigned to the barcode within that cell in that bit (red and gray indicate “0” and “1”, respectively). (C) Two-dimensional histogram of normalized fluorescence intensities for readout 0 and readout 1 of bit 1 for each cell. The fluorescence intensities are normalized to the median values. The dotted line depicts the threshold used for eliminating cells that appear dim in both readouts. The shade of green indicates the number of cells. (D) The percent of barcodes decoded in the imaging experiment that match barcodes determined to be in the library by sequencing (orange) and the number of cells (magenta) above the readout intensity threshold with varying threshold magnitude. The dotted line corresponds with the threshold of 1 shown in (C). (E) Abundance of each barcode. The abundance is the number of cells in the imaging experiment assigned to each barcode. (F) Fluorescence image of mTagBFP2 and fluorescence image of post-activation mMaple3 of the same region as (B). (G) Histograms of median mMaple3 fluorescence intensity normalized to mTagBFP intensity for barcodes associated with the mMaple3-mTagBFP2 fusion gene (red) and for those associated with the mTagBFP2-gene (cyan).</p></caption><graphic xlink:href="143966_fig2" position="float" orientation="portrait" hwp:id="graphic-2"/></fig><p hwp:id="p-14">We then characterized this combined library using our screening strategy. We first measured the fluorescence properties of the cells expressing mTagBFP2 or mTagBFP2-mMaple3 by illuminating with 405-nm light to measure mTagBFP2 fluorescence, illuminating with 405-nm light for an additional ~4s in order to switch the mMaple3 protein to its red-shifted fluorescent state, and then measuring the fluorescence intensity of the red-shifted mMaple3 by illuminating with 560-nm light. We then fixed the cells with methanol and acetone and read out the barcodes in each cell using the procedure described above. We utilized alcohol fixation as opposed to crosslinking fixatives such a paraformaldehyde since it has been established that alcohol fixation greatly enhances the rate of hybridization to RNA<sup><xref ref-type="bibr" rid="c12" hwp:id="xref-ref-12-1" hwp:rel-id="ref-12">12</xref></sup>.</p><p hwp:id="p-15">During the barcode reading step, we examined the fluorescence signal observed for individual cells during different rounds of hybridization and imaging. Indeed, as expected, we found that cells that were bright for one readout of a given bit were dim for the other readout (<xref rid="fig2" ref-type="fig" hwp:id="xref-fig-2-2" hwp:rel-id="F2">Fig. 2B</xref>). For all 1.5 million cells observed, a two-dimensional (2D) histogram of the bit 1 measurements, i.e. the fluorescence intensities determined in the probe 1-0 imaging round and probe 1-1 imaging round, was constructed, and this histogram suggests there are two distinct populations of cells (<xref rid="fig2" ref-type="fig" hwp:id="xref-fig-2-3" hwp:rel-id="F2">Fig. 2C</xref>). The first population appeared bright when hybridized to probe 1-0 and dim when hybridized to probe 1-1 while the second population appeared dim when hybridized to probe 1-0 and bright when hybridized to probe 1-1. This observation is consistent with the readout sequence 1-0 being present in the first population and the readout sequence 1-1 being present in the second population. However, a substantial fraction of cells appeared dark in both imaging rounds, possibly because they are not expressing sufficient barcode RNA, or they are insufficiently permeabilized for readout probe hybridization. We therefore used a thresholding strategy to remove these dim cells from further analysis. Specifically, we require that the “0” or “1”readout signal for each bit is larger than the median intensity observed for that readout signal across all cells. More than 600,000 measured cells satisfied this conservative criterion, and the barcodes expressed in these cells were determined. Among these cells, 84% of the measured barcodes matched a barcode contained in the library as determined by sequencing (<xref rid="fig2" ref-type="fig" hwp:id="xref-fig-2-4" hwp:rel-id="F2">Fig. 2D</xref>).</p><p hwp:id="p-16">For the unmatched 16% of the cells, an experimental error must have occurred. Either the barcode was present in the library but it was not detected by sequencing or the barcode was not present in the library and an error occurred during barcode imaging that misidentified the barcode. While we did not use these cells in further analysis, the presence of this unmatched fraction can be used to estimate our experimental error rates in barcode identification. We first note that the library only contains 4% of all possible barcodes for the 21-bit binary encoding used, as described above, so assuming that a readout error in the imaging process is equally likely to result in a cell being assigned any of the 2<sup>21</sup> barcodes, there is a 96% chance that the error results in identifying a barcode that does not match one in the library (type 1 error). Next, we denote the probability that the barcode in a cell is incorrectly determined as x. Then this probability x multiplied by 96% should be equal to 16%, the fraction of cells that we found containing barcodes that did not match anyone in the library. Hence, x should be equal to 0.167 and the probability that the error results in a different barcode that is present in the library should be only 4% of x, which is ~0.67% (type 2 error). We note that only type 2 errors would affect our final results because only these errors have the capacity to generate a misidentified genotype. Type 1 errors would be detected as unmatched barcodes and discarded. Therefore, our estimated misidentification rate, i.e. the probability that both an error occurs and the error yields a barcode this is already present in the library, is less than one percent.</p><p hwp:id="p-17">The fidelity of the barcode measurement can also be verified by comparing the measured phenotype of cells from the mMaple3 fluorescence level to the phenotype predicted by the measured barcode. We used the phenotype measurements described above to determine the mTagBFP2 fluorescence intensity and the mMaple3 fluorescence intensity of each cell (<xref rid="fig2" ref-type="fig" hwp:id="xref-fig-2-5" hwp:rel-id="F2">Fig. 2F</xref>). All cells that contained the same measured RNA barcode were grouped and the median ratio of mMaple3 intensity to mTagBFP2 intensity was calculated for each group containing at least 5 cells. Since from sequencing we know which barcodes should be associate with mMaple3, we calculated the median intensity ratio for cells identified for each of these barcodes and constructed a histogram of these ratios. Using the same approach, we constructed a histogram of the ratios for the barcodes known to only be associated with mTagBFP2 (<xref rid="fig2" ref-type="fig" hwp:id="xref-fig-2-6" hwp:rel-id="F2">Fig. 2G</xref>). These two distributions are largely separated with only a small overlap. We set a threshold based on the intersection point of the two histograms such that the cells with fluorescence intensity ratios larger than this threshold were classified as containing the mTagBFP2-mMaple3 fusion protein and the cells with the intensity ratio below the threshold as containing mTagBFP2. We then compared these phenotype assignments based on fluorescence intensity to the genotypes based on the measured barcodes. We found that less than 1% of cells have a phenotype and genotype disagreement, indicating a rate of misidentification comparable to that estimated above. However, we note that this error rate is likely an overestimate since the natural spread in the intensity distribution of cells in each group should allow from some overlap of these distributions. Based on the above quantifications, we conclude that our high-throughput imaging-based screening approach is capable of accurately associating the phenotype with the genotype in a large number of cells.</p><p hwp:id="p-18">To demonstrate the utility of our approach for screening a large library of mutants to find proteins with desired properties, we screened for improved variants of a recently developed fluorescent protein, YFAST. YFAST is not itself fluorescent but only becomes fluorescent upon binding to an exogenous, GFP-like chromophore, such as HBR or HMBR (<xref rid="fig3" ref-type="fig" hwp:id="xref-fig-3-1" hwp:rel-id="F3">Fig. 3A</xref>)<sup><xref ref-type="bibr" rid="c8" hwp:id="xref-ref-8-2" hwp:rel-id="ref-8">8</xref></sup>. We created a library of YFAST variants, merged it with our 21-bit barcode library, and sequenced the resulting plasmid library to build the lookup table between variant and barcode.</p><fig id="fig3" position="float" orientation="portrait" fig-type="figure" hwp:id="F3" hwp:rev-id="xref-fig-3-1 xref-fig-3-2 xref-fig-3-3 xref-fig-3-4 xref-fig-3-5 xref-fig-3-6 xref-fig-3-7"><object-id pub-id-type="other" hwp:sub-type="pisa">biorxiv;143966v1/FIG3</object-id><object-id pub-id-type="other" hwp:sub-type="slug">F3</object-id><object-id pub-id-type="publisher-id">fig3</object-id><label>Fig. 3.</label><caption hwp:id="caption-3"><title hwp:id="title-4">Screening YFAST mutant libraries for improved brightness and photobleaching kinetics.</title><p hwp:id="p-19">(A) Schematic diagram of YFAST library design. YFAST is dark on its own, but it becomes fluorescent upon binding to the ligand, for example HMBR<sup><xref ref-type="bibr" rid="c8" hwp:id="xref-ref-8-3" hwp:rel-id="ref-8">8</xref></sup>. A library of YFAST variants fused to mTagBFP2 for normalization is merged with a library of barcodes and transformed into <italic toggle="yes">E. coli</italic> cells. (B) The initial intensity and the photobleaching curve (black circles) of the original YFAST measured from a single cell in the library screen measurement. The initial intensity (gray dashed line) is measured as the intensity of YFAST fluorescence under 488-nm illumination after background subtraction normalized to the mTagBFP2 fluorescence intensity under 405-nm illumination. The photobleaching curve (circles) is measured by illumination with 488-nm light to excite YFAST only. The curve is fit to a double exponential decay (red line) with the background level determined by the intensity of cells that have dark YFAST variants. (C) Scatter plot of the relative brightness and fast-photobleaching amplitude for each measured mutant. Each point depicts the median brightness and fast-photobleaching amplitude of all cells associated with one mutant in the library. The brightness values are normalized to that of the original YFAST. Here only the mutants that contain at least 10 imaged cells are depicted. The original YFAST (green) and several selected mutants (blue, red, and cyan) with greater brightness and/or much smaller fast-photobleaching amplitudes are marked. (D) The photobleaching curves for individual cell corresponding to the original YFAST (green) and one selected mutant (blue dot in (C)) from the library measurement. The fluorescence intensities of the initial time point are normalized to 1. (E) The average bleaching curves for the original YFAST (green) and one selected mutant (blue dot in (C)) measured in isolation in pure culture. The original YFAST and mutant were individually expressed in the <italic toggle="yes">E. coli</italic> cells together with a mTagBFP2 using the same plasmid construct as described for the library constructs. The initial brightness values of YFAST and mutant are normalized as described in (D). (F and G) Bar charts of the relative brightness values (F) and fast-photobleaching amplitudes (G) for several selected mutants as marked in (C) by the same colors. The brightness values are normalized to that of the original YFAST. * indicates a value close to zero and hence not visible in the bar graph.</p></caption><graphic xlink:href="143966_fig3" position="float" orientation="portrait" hwp:id="graphic-3"/></fig><p hwp:id="p-20">We sought to simultaneously improve two properties of YFAST: the fluorophore brightness and the photobleaching kinetics. We note that while fluorophore brightness is a property that can be measured and selected via more traditional screening methods, e.g. FACS, photobleaching kinetics require a time-lapse measurement of the fluorescence from a single cell and, thus, would be challenging to perform with other approaches. In particular, we observed that the photobleaching decay of YFAST follows a double exponential decay with one component decaying much faster than the other. We sought to identify mutants that eliminate this fast decaying component.</p><p hwp:id="p-21">To measure the brightness of different YFAST variants while controlling for potential variations in the expression level, we fused YFAST variants to mTagBFP2 and imaged individual cells with both 405-nm and 488-nm illumination, respectively (<xref rid="fig3" ref-type="fig" hwp:id="xref-fig-3-2" hwp:rel-id="F3">Fig. 3A</xref>). The relative brightness of YFAST was calculated as the ratio of the background subtracted YFAST fluorescence intensity measured with 488-nm illumination in the presence of the chromophore to the mTagBFP2 intensity measured with 405-nm illumination in the absence of the chromophore. To characterize the photobleaching kinetics of YFAST variants, we measured the decrease in intensity over 20 frames under constant 488-nm illumination alone (<xref rid="fig3" ref-type="fig" hwp:id="xref-fig-3-3" hwp:rel-id="F3">Fig. 3B</xref>).</p><p hwp:id="p-22">We constructed a series of YFAST variant libraries that contain (1) all possible single amino acid substitutions, insertions, and deletions (termed single-amino-acid libraries), (2) multiple mutations surrounding the chromophore binding pocket in each library member (chromophore adjacent library), (3) a combination of the best mutations identified from the chromophore adjacent library and the best mutations identified from the single amino acid libraries that are also near the chromophore, or (4) all possible single amino acid substitutions, insertions, and deletions based on a favorable mutant derived from the above libraries. In total, we constructed libraries containing roughly 60,000 unique YFAST variants associated with ~160,000 barcodes, and we used our high-throughput, image-based screening method to measure the brightness, photobleaching kinetics, and genotype for this library of variants across 20 million total cells. From each cell’s photobeaching decay curve, we determine the relative amplitude of the fast decay component (fast-photobleaching amplitude). We then grouped cells based on the genotypes measured and computed the median brightness and fast-photobleaching amplitude for each of these cell groups (<xref rid="fig3" ref-type="fig" hwp:id="xref-fig-3-4" hwp:rel-id="F3">Fig. 3C</xref>).</p><p hwp:id="p-23">We observe a wide range of relative brightness values and fast-photobleaching amplitudes. To confirm that these variations represent true phenotypic variability, we first selected two variants, the wildtype YFAST (green dot in <xref rid="fig3" ref-type="fig" hwp:id="xref-fig-3-5" hwp:rel-id="F3">Fig. 3C</xref>) and a variant with a much smaller (nearly eliminated) fast-photobeaching amplitude (blue dot in <xref rid="fig3" ref-type="fig" hwp:id="xref-fig-3-6" hwp:rel-id="F3">Fig. 3C</xref>), and plotted the measured photobeaching decay curves for the hundreds of measured individual cells that contained the two barcodes associated with these genotypes. The photobleaching decay curves measured for these two sets of cells clearly separate into two populations that correlate strongly with their genotypes, indicating a high degree of reproducibility in the measurements of phenotypes within individual cells. Next, we individually cloned these two YFAST variants and measured their properties in pure culture. We observe nearly identical improvement in photobleaching kinetics in these measurements as we did when these phenotypes were measured in the context of the variant library. By screening ~60,000 variants of YFAST, we identified mutants that are substantially brighter, or mutants that have eliminated the fast-photobeaching component, or mutants with improvements in both aspects (<xref rid="fig3" ref-type="fig" hwp:id="xref-fig-3-7" hwp:rel-id="F3">Fig. 3F, G</xref>). Moreover, because we have an exact genotype measured for each phenotype, we have produced a rich dataset of YFAST mutations and their phenotypic consequences that could be examined to extract information on both the biophysical properties of this protein as well as information that could guide future mutational screens.</p><p hwp:id="p-24">In summary, we developed a method for image-based screening of large genetic variant libraries by coexpressing the genetic variants and barcode that can identify these genetic variants in cells, and determining both the phenotypes of the genetic variants and the barcodes in the same cells using imaging. By reading out barcodes using massively multiplexed FISH, we demonstrated the ability to screen hundreds of thousands of barcodes that correspond to tens of thousands of unique genetic variations. Using this approach, we identified mutations in the YFAST protein, a recently discovered ligand-dependent fluorescent protein, with substantially improved brightness and photostability. We expect that this novel high-throughput, image-based screening method can be applied broadly to improving properties or identifying new properties of proteins and nucleic acids, as well as to deciphering the effects of genes and gene networks on cellular/organism behaviors at the genomic scale.</p><sec id="s1" hwp:id="sec-1"><title hwp:id="title-5">Materials and Methods</title><sec id="s1a" hwp:id="sec-2"><title hwp:id="title-6">Barcode library assembly</title><p hwp:id="p-25">The barcode library consists of a set of plasmids, each containing a DNA barcode sequence that encodes a RNA designed to represent a single 22-bit binary word that is transcribed by the lpp promoter. Every barcode in the library has exactly 22 readout sequences, one corresponding to each bit, designed to be read out by hybridizing fluorescent probes with the complementary sequence. Although 22 bits are present in the barcode, to reduce the number of hybridization rounds, experiments were conducted reading out either 18 or 21 of the possible bits. For each bit position, we assigned one 20-mer sequence to encode a value of 0 and another 20-mer sequence to encode a value of 1. To aid quick hybridization, these encoding sequences were constructed from a three-letter nucleotide alphabet, one with only A, T, and C, in order to destabilize any potential secondary structures<sup><xref ref-type="bibr" rid="c13" hwp:id="xref-ref-13-1" hwp:rel-id="ref-13">13</xref></sup>. The utilized sequences were drawn from those previously used for MERFISH with additional sequences designed using approaches described previously<sup><xref ref-type="bibr" rid="c11" hwp:id="xref-ref-11-3" hwp:rel-id="ref-11">11</xref></sup>. For each barcode, the bits are concatenated with a single G separating each.</p><p hwp:id="p-26">We assembled this barcode library by ligating a mixture of short, overlapping oligonucleotides. For each pair of adjacent bits, there are four unique combinations of bit values. Each corresponding sequence was synthesized as a single-stranded oligo. These oligos were then ligated to from complete, doublestranded barcodes that contain concatenated sequences of all bits with all possible bit values.</p><p hwp:id="p-27">For the ligation step, all oligos were mixed and diluted so that each oligo was present at a concentration of 100 nM. The mixture was phosphorylated by incubation with T4 polynucleotide kinase (16 μL oligo mixture, 2 μL T4 ligase buffer, 2 μL PNK (NEB, M0201S)) at 37 °C for 30 minutes and ligated by adding 1 μL T4 ligase (NEB, M0202S) and incubating for 1 hour at room temperature.</p><p hwp:id="p-28">To prepare a plasmid library containing these barcode sequences along with the desired promoter, we diluted the ligation product 10-fold and amplified by limited-cycle PCR on a Bio-Rad CFX96 using Phusion polymerase (NEB, M0531S0) and EvaGreen (Biotium, 3100). The PCR product was run in an agarose gel and the band of the expected length was extracted and purified (Zymo Zymoclean Gel DNA Recovery Kit, D4002). The purified product was inserted by isothermal assembly<sup><xref ref-type="bibr" rid="c14" hwp:id="xref-ref-14-1" hwp:rel-id="ref-14">14</xref></sup> for 1 hour at 50 °C (NEB NEBuilder HiFi DNA Assembly Master Mix, E2621L) into a plasmid backbone fragment containing the colE1 origin, the ampicillin resistance gene, and other elements taken from the pZ series of plasmids<sup><xref ref-type="bibr" rid="c15" hwp:id="xref-ref-15-1" hwp:rel-id="ref-15">15</xref></sup>. The assembled plasmids were purified (Zymo DNA Clean and Concentration, D4003), eluted into 6 μL water, mixed with 10 μL of electro-competent <italic toggle="yes">E. coli</italic> on ice (NEB, C2986K), and electroporated using an Amaxa Nucleofector II. Immediately after electroporation, 1 mL SOC was added and the culture was incubated at 37 °C on a shaker for one hour. Subsequently, the SOC culture was diluted into 50 mL of LB (Teknova, L8000) supplemented with 0.1 mg/mL carbenicillin (ThermoFisher, 10177-012) and placed on the shaker at 37 °C overnight. The following day, the culture was miniprepped (Zymo Zyppy Plasmid Miniprep Kit, D4019), yielding the complete barcode library.</p></sec><sec id="s1b" hwp:id="sec-3"><title hwp:id="title-7">Assembling protein mutant libraries</title><p hwp:id="p-29">To create a library of mutant proteins, short nucleotide sequences containing regions of the protein of interest with the desired mutations were synthesized as complex oligonucleotide pools. To then create the desired mutant genes from these pools, we amplified the pool and its corresponding expression plasmid via limited cycle PCR and assembled these fragments using isothermal assembly<sup><xref ref-type="bibr" rid="c14" hwp:id="xref-ref-14-2" hwp:rel-id="ref-14">14</xref></sup>. The expression backbone was derived from the colE1 origin and the chloramphenicol resistance gene from the pZ series of plasmids<sup><xref ref-type="bibr" rid="c15" hwp:id="xref-ref-15-2" hwp:rel-id="ref-15">15</xref></sup>. Oligo pool synthesis is prone to deletions, which could lead to frameshift mutations that produce non-viable proteins. To remove these variants prior to measurement, the protein variants were translationally fused upstream to the chloramphenicol resistance protein. These constructs were electroporated into <italic toggle="yes">E. coli,</italic> as described above, and these cultures grown in the presence of chloramphenicol to select only for protein variants that did not have frame-shift mutations and which could, thus, translate component chloramphenicol resistance. These plasmids were reisolated via plasmid miniprep and the genetic variants extracted via PCR prior to combination with the barcode library.</p></sec><sec id="s1c" hwp:id="sec-4"><title hwp:id="title-8">Merging mutation libraries with the barcode library</title><p hwp:id="p-30">To merge a mutant library with the barcode library, the corresponding halves of each plasmid library were amplified by limited-cycle PCR. Of note, the forward primer for amplifying the barcode library contained 20 random nucleotides so that each assembled plasmid contained a 20-mer unique molecular identifier (UMI). Also, the protein mutant half contained the plasmid’s replication origin (colE1) while the barcode half contained the ampicillin resistance gene ensuring that only plasmids containing both halves were competent. The two halves were assembled by isothermal assemble and transfected into electrocompetent <italic toggle="yes">E. coli</italic> as described earlier. After incubating in SOC for 1 hour at 37 °C, the culture was again diluted into 50 mL and grown until it reached an OD600 of ~1. To limit the possibility that a single bacterium had taken up more than one plasmid, plasmids were extracted again from this culture, and re-electroporated into fresh <italic toggle="yes">E. coli</italic> at a defined, low concentration. This culture was then grown and rediluted to the desired number of cells assuming an OD600 of 1 corresponded to 800 million cells. The diluted culture was incubated at 37 °C overnight and the following day it was archived for future imaging experiments by diluting 1:1 in 50% glycerol (Teknova, G1796), separating into 100 μL aliquots, and stored at −80 °C. The remaining culture was mini-prepped to use as a PCR template for constructing the barcode to genotype lookup table.</p></sec><sec id="s1d" hwp:id="sec-5"><title hwp:id="title-9">Constructing barcode to genotype lookup table</title><p hwp:id="p-31">Since barcodes and mutants are assembled randomly, next generation sequencing was used to construct a look-up table from barcode to mutant. The total length of the protein mutant and the barcode exceeded the read length of the sequencing platform used (Illumina MiSeq). To circumvent this challenge, multiple fragments were extracted from each library, sequenced independently and grouped computationally using the UMI.</p><p hwp:id="p-32">The mini-prepped libraries were prepared for sequencing by two sequential limited-cycle PCRs. The first PCR extracted the desired region while adding the sequencing priming regions, and the second PCR added multiplexing indices and the Illumina adapter sequences. Between PCRs, the product was purified in an agarose gel and the final product was gel purified prior to sequencing.</p><p hwp:id="p-33">For each sequencing read, the corresponding barcode or mutant sequence was extracted. The reads were then grouped by common UMI and the most frequently occurring barcode and protein mutant seen for each UMI was assigned to that UMI, constructing the barcode to mutant lookup table for every variant in the library.</p></sec><sec id="s1e" hwp:id="sec-6"><title hwp:id="title-10">Phenotype and barcode imaging</title><p hwp:id="p-34">Each library was prepared for imaging by thawing the 100 μL aliquot from −80 °C to room temperature and diluting into 2 mL LB supplemented with 0.1mg/mL carbenicillin. Imaging coverslips (Bioptechs, 0420-0323-2) in 60-mm-diameter cell culture dishes were prepared by covering in 1% polyethylenimine (Sigma-Aldrich, P3143-500ML) in water for 30 minutes followed by a single wash with phosphate buffered saline (PBS). The <italic toggle="yes">E. coli</italic> culture was diluted 10-fold into PBS, poured into the culture dish, and spun at 100g for 5 minutes to adhere cells to the surface.</p><p hwp:id="p-35">The sample coverslip was assembled into a Bioptech’s FCS2 flow chamber. A peristaltic pump (Gilson, MINIPULS 3) pulled liquid through the chamber while three computer-controlled valves (Hamilton, MVP and HVXM 8-5) were used to select the input fluid. The sample was imaged on a custom microscope built around a Nikon Ti-U microscope body with a Nikon CFI Plan Apo Lambda 60x oil immersion objective with 1.4 NA. Illumination was provided at 405, 488, 560, 647, and 750 nm using solid-state single-mode lasers (Coherent, Obis 405nm LX 200mW; Coherent, Genesis MX488-1000; MPB Communications, 2RU-VFL-P-2000-560-B1R, MPB Communication, 2RU-VFL-P-1500-647-B1R; and MPB Communications, 2RU-VFL-P-500-750-B1R) in addition to the overhead halogen lamp for bright field illumination. The Gaussian profile from the lasers was transformed into a top-hat profile using a refractive beam shaper (Newport, GBS-AR14). The intensity of the 488-, 560-, and 647-nm lasers was controlled by an acousto-optic tunable-filter (AOTF), the 405-nm laser was modulated by a direct digital signal, and the 750-nm laser and overhead lamp were switched by mechanical shutters. The excitation illumination was separated from the emission using a custom dichroic (Chroma, zy405/488/561/647/752RP-UF1) and emission filter (Chroma, ZET405/488/461/647-656/752m). The emission was imaged onto an Andor iXon+ 888 EMCCD camera. During acquisition, the sample was translated using a motorized XY stage (Ludl, BioPrecision2) and kept in focus using a home-built autofocus system.</p><p hwp:id="p-36">Phenotype measurements were conducted immediately after cells were deposited onto the coverslip and inserted into the flow chamber. For the YFAST mutants, images were first acquired in PBS in the absence of the chromophore with 405-nm illumination to measure the mTagBFP2 fluorescence followed by an image with brightfield illumination for alignment between multiple imaging rounds. Then 10 μM HMBR or HBR in PBS was flowed over the cells and a fluorescence image was acquired with 488-nm illumination to measure YFAST and a brightfield image for alignment, followed by twenty or eighty images at 8.4Hz with constant 488-nm illumination to measure the decrease in intensity upon photobleaching. In each imaging round, images were acquired at 1,427 or 3,223 locations in the sample.</p><p hwp:id="p-37">Following the phenotype measurement, the cells were fixed by incubation in a mixture of methanol and acetone at a 4:1 ratio for 30 minutes. To prevent salts from precipitating and clogging the flow system, water was flowed before and after the fixation mixture. Once fixed, the cells were washed in 2x Saline Sodium Chloride (SSC) and hybridization began.</p><p hwp:id="p-38">To determine the RNA barcode expressed within each cell, MERFISH was performed using similar protocols to those described previously<sup><xref ref-type="bibr" rid="c11" hwp:id="xref-ref-11-4" hwp:rel-id="ref-11">11</xref></sup>. For each hybridization round, the sample was incubated for 30 minutes in hybridization buffer [2xSSC; 5% w/v dextran sulfate (EMD Millipore, 3730-100ML), 5% w/v ethylene carbonate (Sigma-Aldrich, E26258-500G), 0.05% w/v yeast tRNA, and 0.1% v/v Murine RNase inhibitor (NEB, M0314L)] with a mixture of readout probes labeled with either ATTO565, Cy5, or Alexa750 (Bio-Synthesis Inc) each at a concentration of 10 nM. The dyes were linked to the readout probes through a disulfide bond. Then, the hybridization buffer was replaced by an oxygen-scavenging buffer for imaging [2xSSC; 50 mM TrisHCl pH 8, 10% w/v glucose (Sigma-Aldrich, G8270), 2 mM Trolox (Sigma-Aldrich, 238813), 0.5 mg/mL glucose oxidase (Sigma-Aldrich, G2133), and 40 μg/mL catalase (Sigma-Aldrich, C100-500mg)]. Each position in the flow cell was imaged with 750-, 647-, and 560-nm illumination from longest to shortest wavelength followed by brightfield illumination before continuing to the next location. Following the imaging of all regions, the disulfide bond linking the dyes to the readout probes were cleaved by incubating the sample in 50 mM tris (2-carboxyethyl)phosphine (TCEP; Sigma-Aldrich, 646547-10X1ML) in 2xSSC for 15 minutes. The sample was then rinsed in 2xSSC and the next hybridization round started. For each round of hybridization, three readouts with spectrally discernable dyes were hybridized simultaneously. Altogether, with 14 hybridization rounds, all 42 readouts corresponding to 21 bits were measured in 40 hours. For smaller libraries, the imaging area and the number of hybridization rounds were decreased to reduce the measurement time to 22 hours.</p></sec><sec id="s1f" hwp:id="sec-7"><title hwp:id="title-11">Image analysis</title><p hwp:id="p-39">To correct for residual illumination variations across the camera, a flat field correction was performed. Every image was divided by the mean intensity image for all images with the given illumination color. Then, the images for different rounds corresponding to the same region were registered using the image acquired under bright field illumination by up-sampled cross-correlation creating a normalized image stack of all images at each position in the flow chamber. If the radial power spectral density of any given bright field image did not contain sufficient high frequency power, the image was designated as out-of-focus and all images for the corresponding region were excluded for further analysis.</p><p hwp:id="p-40">To extract cell intensities, the edges of each cell were detected using the Canny edge detection algorithm on the first image acquired with 405-nm illumination. The edges that formed closed boundaries were filled in and closed regions of pixels were extracted. If a given closed pixel region had a filled area of more than 20 pixels and the ratio of the filled area to the area of the convex hull was greater than 0.9, it was classified as a cell. To increase the cell detection efficiency, the detected cells were then removed from the binary image, the image was dilated, filled, and eroded and cells were extracted again. This allowed cells where gaps exist in the detected edges to still be detected. For each cell, the mean intensity was extracted for the corresponding pixels in every image.</p><p hwp:id="p-41">From the cell intensities, the phenotypes and barcodes were calculated. For each measured readout sequence, the measured intensity was normalized by subtracting the minimum and taking the median of the signal observed for that readout sequence in all cells. To determine whether a barcode contained a “1” or a “0” at each bit, the measured intensity of the “1” readout sequence and the “0” readout sequence for that bit were compared. Specifically, a threshold was selected on the ratio of these two values. If this ratio was above the threshold, the bit was called as a “1”. If it fell below, the bit was called as a “0”. Because the “1” and “0” readout sequences associated with each bit might be assigned to different fluorophores, it was necessary to optimize this threshold for each bit individually. This optimization was performed by randomly selecting 150 barcodes (a training set) from the set of known barcodes contained in the library, as identified by sequencing. An initial set of thresholds was selected and the fraction of cells matching these barcodes was determined. The threshold for each bit was then varied independently to identify the threshold set that maximizes this fraction. This optimized threshold set was then used for determining the bit values for all cells.</p><p hwp:id="p-42">Once the barcode was determined for each cells, cells were grouped by barcode and the median of the various phenotype values was computed to determine the measured phenotype for the genotype corresponding to that barcode. For YFAST measurements, the normalized intensity was determined by the ratio of the YFAST fluorescence intensities under 488-nm illumination in the presence of the YFAST chromophore to the mTagBFP2 fluorescence intensities under 405-nm illumination in the absence of chromophore. To account for the non-negligible fluorescence background present in <italic toggle="yes">E. coli</italic> upon 488-nm illumination, the magnitude of the background was subtracted before calculating the fluorescence ratio. The background was estimated by calculating the median intensity of all cells upon 488-nm illumination predicted to contain a non-fluorescent YFAST mutant. Cells, grouped by barcode, were assigned to the dark population if the Pearson correlation coefficient between the 488-nm intensity and the 405-nm intensity for the grouped cells fell below the arbitrary threshold of 0.2. When the two intensities are uncorrelated, it suggests the number of YFAST proteins in the cells associated with that barcode does not affect the brightness of the cell and hence the YFAST should be dark. To determine the relative amplitude of the fast decay component of the photobleaching measurement of each YFAST mutant, we fit the background subtracted photobleaching curve to the sum of two exponentials, with one of the decay rates set to the fast decay rate determined from the original YFAST. To determine the fast decay rate of the original YFAST, its background subtracted photobleaching curve was fit to the sum of two exponentials with both decay rates as adjustable parameters and the faster of the two decay rates was selected.</p></sec></sec></body><back><ref-list hwp:id="ref-list-1"><title hwp:id="title-12">References</title><ref id="c1" hwp:id="ref-1" hwp:rev-id="xref-ref-1-1"><label>1.</label><citation publication-type="journal" citation-type="journal" ref:id="143966v1.1" ref:linkable="yes" ref:use-reference-as-is="yes" hwp:id="citation-1"><string-name name-style="western" hwp:sortable="Cadwell R. C."><surname>Cadwell</surname>, <given-names>R. C.</given-names></string-name> &amp; <string-name name-style="western" hwp:sortable="Joyce G. F."><surname>Joyce</surname>, <given-names>G. F.</given-names></string-name> <article-title hwp:id="article-title-2">Randomization of genes by PCR mutagenesis</article-title>. <source hwp:id="source-1">PCR Methods Appl.</source> <volume>2</volume>, <fpage>28</fpage>–<lpage>33</lpage> (<year>1992</year>).</citation></ref><ref id="c2" hwp:id="ref-2" hwp:rev-id="xref-ref-2-1"><label>2.</label><citation publication-type="journal" citation-type="journal" ref:id="143966v1.2" ref:linkable="yes" ref:use-reference-as-is="yes" hwp:id="citation-2"><string-name name-style="western" hwp:sortable="Kosuri S."><surname>Kosuri</surname>, <given-names>S.</given-names></string-name> &amp; <string-name name-style="western" hwp:sortable="Church G. M."><surname>Church</surname>, <given-names>G. M.</given-names></string-name> <article-title hwp:id="article-title-3">Large-scale de novo DNA synthesis: technologies and applications</article-title>. <source hwp:id="source-2">Nat. Methods</source> <volume>11</volume>, <fpage>499</fpage>–<lpage>507</lpage> (<year>2014</year>).</citation></ref><ref id="c3" hwp:id="ref-3" hwp:rev-id="xref-ref-3-1"><label>3.</label><citation publication-type="journal" citation-type="journal" ref:id="143966v1.3" ref:linkable="yes" ref:use-reference-as-is="yes" hwp:id="citation-3"><string-name name-style="western" hwp:sortable="Smith G. P."><surname>Smith</surname>, <given-names>G. P.</given-names></string-name> <article-title hwp:id="article-title-4">Filamentous fusion phage: novel expression vectors that display cloned antigens on the virion surface</article-title>. <source hwp:id="source-3">Science</source> <volume>228</volume>, <fpage>1315</fpage>–<lpage>7</lpage> (<year>1985</year>).</citation></ref><ref id="c4" hwp:id="ref-4" hwp:rev-id="xref-ref-4-1"><label>4.</label><citation publication-type="journal" citation-type="journal" ref:id="143966v1.4" ref:linkable="yes" ref:use-reference-as-is="yes" hwp:id="citation-4"><string-name name-style="western" hwp:sortable="Miltenyi S."><surname>Miltenyi</surname>, <given-names>S.</given-names></string-name>, <string-name name-style="western" hwp:sortable="Müller W."><surname>Müller</surname>, <given-names>W.</given-names></string-name>, <string-name name-style="western" hwp:sortable="Weichel W."><surname>Weichel</surname>, <given-names>W.</given-names></string-name> &amp; <string-name name-style="western" hwp:sortable="Radbruch A."><surname>Radbruch</surname>, <given-names>A.</given-names></string-name> <article-title hwp:id="article-title-5">High gradient magnetic cell separation with MACS</article-title>. <source hwp:id="source-4">Cytometry</source> <volume>11</volume>, <fpage>231</fpage>–<lpage>238</lpage> (<year>1990</year>).</citation></ref><ref id="c5" hwp:id="ref-5" hwp:rev-id="xref-ref-5-1"><label>5.</label><citation publication-type="journal" citation-type="journal" ref:id="143966v1.5" ref:linkable="yes" ref:use-reference-as-is="yes" hwp:id="citation-5"><string-name name-style="western" hwp:sortable="Anderson M. T."><surname>Anderson</surname>, <given-names>M. T.</given-names></string-name> <etal>et al.</etal> <article-title hwp:id="article-title-6">Simultaneous fluorescence-activated cell sorter analysis of two distinct transcriptional elements within a single cell using engineered green fluorescent proteins</article-title>. <source hwp:id="source-5">Proc. Natl. Acad. Sci.</source> <volume>93</volume>, <fpage>8508</fpage>–<lpage>8511</lpage> (<year>1996</year>).</citation></ref><ref id="c6" hwp:id="ref-6" hwp:rev-id="xref-ref-6-1 xref-ref-6-2 xref-ref-6-3 xref-ref-6-4 xref-ref-6-5"><label>6.</label><citation publication-type="journal" citation-type="journal" ref:id="143966v1.6" ref:linkable="yes" ref:use-reference-as-is="yes" hwp:id="citation-6"><string-name name-style="western" hwp:sortable="Chen K. H."><surname>Chen</surname>, <given-names>K. H.</given-names></string-name>, <string-name name-style="western" hwp:sortable="Boettiger A. N."><surname>Boettiger</surname>, <given-names>A. N.</given-names></string-name>, <string-name name-style="western" hwp:sortable="Moffitt J. R."><surname>Moffitt</surname>, <given-names>J. R.</given-names></string-name>, <string-name name-style="western" hwp:sortable="Wang S."><surname>Wang</surname>, <given-names>S.</given-names></string-name> &amp; <string-name name-style="western" hwp:sortable="Zhuang X."><surname>Zhuang</surname>, <given-names>X.</given-names></string-name> <article-title hwp:id="article-title-7">Spatially resolved, highly multiplexed RNA profiling in single cells</article-title>. <source hwp:id="source-6">Science (80-.).</source> <volume>348</volume>, <fpage>aaa6090</fpage>–<lpage>aaa6090</lpage> (<year>2015</year>).</citation></ref><ref id="c7" hwp:id="ref-7" hwp:rev-id="xref-ref-7-1"><label>7.</label><citation publication-type="journal" citation-type="journal" ref:id="143966v1.7" ref:linkable="yes" ref:use-reference-as-is="yes" hwp:id="citation-7"><string-name name-style="western" hwp:sortable="Wang S."><surname>Wang</surname>, <given-names>S.</given-names></string-name>, <string-name name-style="western" hwp:sortable="Moffitt J. R."><surname>Moffitt</surname>, <given-names>J. R.</given-names></string-name>, <string-name name-style="western" hwp:sortable="Dempsey G. T."><surname>Dempsey</surname>, <given-names>G. T.</given-names></string-name>, <string-name name-style="western" hwp:sortable="Xie X. S."><surname>Xie</surname>, <given-names>X. S.</given-names></string-name> &amp; <string-name name-style="western" hwp:sortable="Zhuang X."><surname>Zhuang</surname>, <given-names>X.</given-names></string-name> <article-title hwp:id="article-title-8">Characterization and development of photoactivatable fluorescent proteins for single-molecule-based superresolution imaging</article-title>. <source hwp:id="source-7">Proc. Natl. Acad. Sci.</source> <volume>111</volume>, <fpage>8452</fpage>–<lpage>8457</lpage> (<year>2014</year>).</citation></ref><ref id="c8" hwp:id="ref-8" hwp:rev-id="xref-ref-8-1 xref-ref-8-2 xref-ref-8-3"><label>8.</label><citation publication-type="journal" citation-type="journal" ref:id="143966v1.8" ref:linkable="yes" ref:use-reference-as-is="yes" hwp:id="citation-8"><string-name name-style="western" hwp:sortable="Plamont M.-A"><surname>Plamont</surname>, <given-names>M.-A</given-names></string-name>. <etal>et al.</etal> <article-title hwp:id="article-title-9">Small fluorescence-activating and absorption-shifting tag for tunable protein imaging in vivo</article-title>. <source hwp:id="source-8">Proc. Natl. Acad. Sci. U. S. A.</source> <volume>113</volume>, <fpage>497</fpage>–<lpage>502</lpage> (<year>2016</year>).</citation></ref><ref id="c9" hwp:id="ref-9" hwp:rev-id="xref-ref-9-1"><label>9.</label><citation publication-type="journal" citation-type="journal" ref:id="143966v1.9" ref:linkable="yes" ref:use-reference-as-is="yes" hwp:id="citation-9"><string-name name-style="western" hwp:sortable="Femino A. M."><surname>Femino</surname>, <given-names>A. M.</given-names></string-name>, <string-name name-style="western" hwp:sortable="Fay F. S."><surname>Fay</surname>, <given-names>F. S.</given-names></string-name>, <string-name name-style="western" hwp:sortable="Fogarty K."><surname>Fogarty</surname>, <given-names>K.</given-names></string-name> &amp; <string-name name-style="western" hwp:sortable="Singer R."><surname>Singer</surname>, <given-names>R.</given-names></string-name> <article-title hwp:id="article-title-10">Visualization of Single RNA Transcripts in Situ</article-title>. <source hwp:id="source-9">Science (80-.).</source> <volume>280</volume>, <fpage>585</fpage>–<lpage>590</lpage> (<year>1998</year>).</citation></ref><ref id="c10" hwp:id="ref-10" hwp:rev-id="xref-ref-10-1"><label>10.</label><citation publication-type="journal" citation-type="journal" ref:id="143966v1.10" ref:linkable="yes" ref:use-reference-as-is="yes" hwp:id="citation-10"><string-name name-style="western" hwp:sortable="Raj A."><surname>Raj</surname>, <given-names>A.</given-names></string-name>, <string-name name-style="western" hwp:sortable="van den Bogaard P."><surname>van den Bogaard</surname>, <given-names>P.</given-names></string-name>, <string-name name-style="western" hwp:sortable="Rifkin S. A."><surname>Rifkin</surname>, <given-names>S. A.</given-names></string-name>, <string-name name-style="western" hwp:sortable="van Oudenaarden A."><surname>van Oudenaarden</surname>, <given-names>A.</given-names></string-name> &amp; <string-name name-style="western" hwp:sortable="Tyagi S."><surname>Tyagi</surname>, <given-names>S.</given-names></string-name> <article-title hwp:id="article-title-11">Imaging individual mRNA molecules using multiple singly labeled probes</article-title>. <source hwp:id="source-10">Nat. Methods</source> <volume>5</volume>, <fpage>877</fpage>–<lpage>879</lpage> (<year>2008</year>).</citation></ref><ref id="c11" hwp:id="ref-11" hwp:rev-id="xref-ref-11-1 xref-ref-11-2 xref-ref-11-3 xref-ref-11-4"><label>11.</label><citation publication-type="other" citation-type="journal" ref:id="143966v1.11" ref:linkable="yes" ref:use-reference-as-is="yes" hwp:id="citation-11"><string-name name-style="western" hwp:sortable="Moffitt J. R."><surname>Moffitt</surname>, <given-names>J. R.</given-names></string-name> <etal>et al.</etal> <article-title hwp:id="article-title-12">High-throughput single-cell gene-expression profiling with multiplexed error-robust fluorescence in situ hybridization</article-title>. <source hwp:id="source-11">Proc. Natl. Acad. Sci.</source> <fpage>201612826</fpage> (<year>2016</year>). doi:<pub-id pub-id-type="doi">10.1073/pnas.1612826113</pub-id></citation></ref><ref id="c12" hwp:id="ref-12" hwp:rev-id="xref-ref-12-1"><label>12.</label><citation publication-type="journal" citation-type="journal" ref:id="143966v1.12" ref:linkable="yes" ref:use-reference-as-is="yes" hwp:id="citation-12"><string-name name-style="western" hwp:sortable="Shaffer S. M."><surname>Shaffer</surname>, <given-names>S. M.</given-names></string-name>, <string-name name-style="western" hwp:sortable="Wu M.-T."><surname>Wu</surname>, <given-names>M.-T.</given-names></string-name>, <string-name name-style="western" hwp:sortable="Levesque M. J."><surname>Levesque</surname>, &amp; <given-names>M. J.</given-names></string-name>, <string-name name-style="western" hwp:sortable="Raj A."><surname>Raj</surname>, <given-names>A.</given-names></string-name>. <article-title hwp:id="article-title-13">Turbo FISH: A Method for Rapid Single Molecule RNA FISH</article-title>. <source hwp:id="source-12">PLoS One</source> <volume>8</volume>, <fpage>e75120</fpage> (<year>2013</year>).</citation></ref><ref id="c13" hwp:id="ref-13" hwp:rev-id="xref-ref-13-1"><label>13.</label><citation publication-type="journal" citation-type="journal" ref:id="143966v1.13" ref:linkable="yes" ref:use-reference-as-is="yes" hwp:id="citation-13"><string-name name-style="western" hwp:sortable="Zhang Z."><surname>Zhang</surname>, <given-names>Z.</given-names></string-name>, <string-name name-style="western" hwp:sortable="Revyakin A."><surname>Revyakin</surname>, <given-names>A.</given-names></string-name>, <string-name name-style="western" hwp:sortable="Grimm J. B."><surname>Grimm</surname>, <given-names>J. B.</given-names></string-name>, <string-name name-style="western" hwp:sortable="Lavis L. D."><surname>Lavis</surname>, <given-names>L. D.</given-names></string-name> &amp; <string-name name-style="western" hwp:sortable="Tjian R."><surname>Tjian</surname>, <given-names>R.</given-names></string-name> <article-title hwp:id="article-title-14">Single-molecule tracking of the transcription cycle by sub-second RNA detection</article-title>. <source hwp:id="source-13">Elife</source> <volume>3</volume>, <fpage>e01775</fpage> (<year>2014</year>).</citation></ref><ref id="c14" hwp:id="ref-14" hwp:rev-id="xref-ref-14-1 xref-ref-14-2"><label>14.</label><citation publication-type="journal" citation-type="journal" ref:id="143966v1.14" ref:linkable="yes" ref:use-reference-as-is="yes" hwp:id="citation-14"><string-name name-style="western" hwp:sortable="Gibson D. G."><surname>Gibson</surname>, <given-names>D. G.</given-names></string-name> <etal>et al.</etal> <article-title hwp:id="article-title-15">Enzymatic assembly of DNA molecules up to several hundred kilobases</article-title>. <source hwp:id="source-14">Nat. Methods</source> <volume>6</volume>, <fpage>343</fpage>–<lpage>345</lpage> (<year>2009</year>).</citation></ref><ref id="c15" hwp:id="ref-15" hwp:rev-id="xref-ref-15-1 xref-ref-15-2"><label>15.</label><citation publication-type="journal" citation-type="journal" ref:id="143966v1.15" ref:linkable="yes" ref:use-reference-as-is="yes" hwp:id="citation-15"><string-name name-style="western" hwp:sortable="Lutz R."><surname>Lutz</surname>, <given-names>R.</given-names></string-name> &amp; <string-name name-style="western" hwp:sortable="Bujard H."><surname>Bujard</surname>, <given-names>H.</given-names></string-name> <article-title hwp:id="article-title-16">Independent and tight regulation of transcriptional units in Escherichia coli via the LacR/O, the TetR/O and AraC/I1-I2 regulatory elements</article-title>. <source hwp:id="source-15">Nucleic Acids Res.</source> <volume>25</volume>, <fpage>1203</fpage>–<lpage>10</lpage> (<year>1997</year>).</citation></ref></ref-list></back></article>
