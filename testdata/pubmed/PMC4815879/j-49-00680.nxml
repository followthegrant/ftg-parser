
<!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.0 20120330//EN" "JATS-archivearticle1.dtd">
<article xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:mml="http://www.w3.org/1998/Math/MathML" article-type="research-article"><?properties open_access?><front><journal-meta><journal-id journal-id-type="nlm-ta">J Appl Crystallogr</journal-id><journal-id journal-id-type="iso-abbrev">J Appl Crystallogr</journal-id><journal-id journal-id-type="publisher-id">J. Appl. Cryst.</journal-id><journal-title-group><journal-title>Journal of Applied Crystallography</journal-title></journal-title-group><issn pub-type="ppub">0021-8898</issn><issn pub-type="epub">1600-5767</issn><publisher><publisher-name>International Union of Crystallography</publisher-name></publisher></journal-meta><article-meta><article-id pub-id-type="pmid">27047311</article-id><article-id pub-id-type="pmc">4815879</article-id><article-id pub-id-type="publisher-id">zd5001</article-id><article-id pub-id-type="doi">10.1107/S1600576716004751</article-id><article-id pub-id-type="coden">JACGAR</article-id><article-id pub-id-type="pii">S1600576716004751</article-id><article-categories><subj-group subj-group-type="heading"><subject>Computer Programs</subject></subj-group></article-categories><title-group><article-title>Recent developments in <italic>CrystFEL</italic>
<xref ref-type="fn" rid="fn1">1</xref>
</article-title><alt-title>Recent developments in <italic>CrystFEL</italic></alt-title></title-group><contrib-group><contrib contrib-type="author"><name><surname>White</surname><given-names>Thomas A.</given-names></name><xref ref-type="aff" rid="a">a</xref><xref ref-type="corresp" rid="cor">*</xref></contrib><contrib contrib-type="author"><name><surname>Mariani</surname><given-names>Valerio</given-names></name><xref ref-type="aff" rid="a">a</xref></contrib><contrib contrib-type="author"><name><surname>Brehm</surname><given-names>Wolfgang</given-names></name><xref ref-type="aff" rid="b">b</xref></contrib><contrib contrib-type="author"><name><surname>Yefanov</surname><given-names>Oleksandr</given-names></name><xref ref-type="aff" rid="a">a</xref></contrib><contrib contrib-type="author"><name><surname>Barty</surname><given-names>Anton</given-names></name><xref ref-type="aff" rid="a">a</xref></contrib><contrib contrib-type="author"><name><surname>Beyerlein</surname><given-names>Kenneth R.</given-names></name><xref ref-type="aff" rid="a">a</xref></contrib><contrib contrib-type="author"><name><surname>Chervinskii</surname><given-names>Fedor</given-names></name><xref ref-type="aff" rid="c">c</xref></contrib><contrib contrib-type="author"><name><surname>Galli</surname><given-names>Lorenzo</given-names></name><xref ref-type="aff" rid="a">a</xref></contrib><contrib contrib-type="author"><name><surname>Gati</surname><given-names>Cornelius</given-names></name><xref ref-type="aff" rid="a">a</xref></contrib><contrib contrib-type="author"><name><surname>Nakane</surname><given-names>Takanori</given-names></name><xref ref-type="aff" rid="d">d</xref></contrib><contrib contrib-type="author"><name><surname>Tolstikova</surname><given-names>Alexandra</given-names></name><xref ref-type="aff" rid="a">a</xref><xref ref-type="aff" rid="e">e</xref></contrib><contrib contrib-type="author"><name><surname>Yamashita</surname><given-names>Keitaro</given-names></name><xref ref-type="aff" rid="f">f</xref></contrib><contrib contrib-type="author"><name><surname>Yoon</surname><given-names>Chun Hong</given-names></name><xref ref-type="aff" rid="a">a</xref><xref ref-type="author-notes" rid="aunote1">&#x02021;</xref></contrib><contrib contrib-type="author"><name><surname>Diederichs</surname><given-names>Kay</given-names></name><xref ref-type="aff" rid="b">b</xref></contrib><contrib contrib-type="author"><name><surname>Chapman</surname><given-names>Henry N.</given-names></name><xref ref-type="aff" rid="a">a</xref><xref ref-type="aff" rid="e">e</xref><xref ref-type="aff" rid="g">g</xref></contrib><aff id="a"><label>a</label>Centre for Free-Electron Laser Science, Deutsches Elektronen-Synchrotron DESY, Notkestrasse 85, 22607 Hamburg, <country>Germany</country></aff><aff id="b"><label>b</label>Department of Biology, Universit&#x000e4;t Konstanz, Box 647, 78457 Konstanz, <country>Germany</country></aff><aff id="c"><label>c</label>Moscow Institute of Physics and Technology, 141700 Moscow, <country>Russian Federation</country></aff><aff id="d"><label>d</label>Department of Biological Sciences, Graduate School of Science, The University of Tokyo, 7-3-1 Hongo, Bunkyo-ku, Tokyo 113-0033, Japan</aff><aff id="e"><label>e</label>Department of Physics, University of Hamburg, Luruper Chaussee 149, 22761 Hamburg, <country>Germany</country></aff><aff id="f"><label>f</label>RIKEN SPring-8 Center, Sayo, 679-5148, <country>Japan</country></aff><aff id="g"><label>g</label>Centre for Ultrafast Imaging, Luruper Chaussee 149, 22761 Hamburg, <country>Germany</country></aff></contrib-group><author-notes><corresp id="cor">Correspondence e-mail: <email>taw@physics.org</email></corresp><fn id="aunote1" fn-type="current-aff"><label>&#x02021;</label><p>Present address: Linac Coherent Light Source, SLAC National Accelerator Laboratory, 2575 Sand Hill Road, Menlo Park, CA 94025, USA.</p></fn></author-notes><pub-date pub-type="collection"><day>01</day><month>4</month><year>2016</year></pub-date><pub-date pub-type="epub"><day>29</day><month>3</month><year>2016</year></pub-date><pub-date pub-type="pmc-release"><day>29</day><month>3</month><year>2016</year></pub-date><!-- PMC Release delay is 0 months and 0 days and was based on the
							<pub-date pub-type="epub"/>. --><volume>49</volume><issue>Pt 2</issue><issue-id pub-id-type="publisher-id">j160200</issue-id><fpage>680</fpage><lpage>689</lpage><history><date date-type="received"><day>20</day><month>11</month><year>2015</year></date><date date-type="accepted"><day>21</day><month>3</month><year>2016</year></date></history><permissions><copyright-statement>&#x000a9; Thomas A. White et al. 2016</copyright-statement><copyright-year>2016</copyright-year><license license-type="open-access" xlink:href="http://creativecommons.org/licenses/by/2.0/uk/"><license-p>This is an open-access article distributed under the terms of the Creative Commons Attribution Licence, which permits
unrestricted use, distribution, and reproduction in any medium, provided the original authors and source are cited.</license-p></license></permissions><self-uri xlink:type="simple" xlink:href="http://dx.doi.org/10.1107/S1600576716004751">A full version of this article is available from Crystallography Journals Online.</self-uri><abstract abstract-type="toc"><p>Developments in the <italic>CrystFEL</italic> software suite, for processing diffraction data from &#x02018;serial crystallography&#x02019; experiments, are described.</p></abstract><abstract><p>
<italic>CrystFEL</italic> is a suite of programs for processing data from &#x02018;serial crystallography&#x02019; experiments, which are usually performed using X-ray free-electron lasers (FELs) but also increasingly with other X-ray sources. The <italic>CrystFEL</italic> software suite has been under development since 2009, just before the first hard FEL experiments were performed, and has been significantly updated and improved since then. This article describes the most important improvements which have been made to <italic>CrystFEL</italic> since the first release version. These changes include the addition of new programs to the suite, the ability to resolve &#x02018;indexing ambiguities&#x02019; and several ways to improve the quality of the integrated data by more accurately modelling the underlying diffraction physics.</p></abstract><kwd-group><kwd>data processing</kwd><kwd>serial crystallography</kwd><kwd>X-ray free-electron lasers</kwd><kwd>XFELs</kwd><kwd>computer programs</kwd></kwd-group></article-meta></front><body><sec id="sec1"><label>1.</label><title>Introduction &#x000a0; </title><p>
<italic>CrystFEL</italic> is a software suite created to address the processing needs of serial femtosecond crystallography (SFX). It has been under development since 2009 and was first made publicly available in 2012 (White <italic>et&#x000a0;al.</italic>, 2012<xref ref-type="bibr" rid="bb32"> &#x025b8;</xref>). It has become the most widely used software for this purpose, with over 40 journal articles describing significant use. Many of these were performed with no involvement whatsoever from the developers or &#x02018;core&#x02019; advanced users. Alongside free-electron laser (FEL) experiments, <italic>CrystFEL</italic> is equally applicable to serial crystallography (SX) experiments performed using synchrotron light sources (Stellato <italic>et&#x000a0;al.</italic>, 2014<xref ref-type="bibr" rid="bb27"> &#x025b8;</xref>; Nogly <italic>et&#x000a0;al.</italic>, 2015<xref ref-type="bibr" rid="bb20"> &#x025b8;</xref>).</p><p>The first release version of <italic>CrystFEL</italic> was 0.3.0, which was preceded by several internal test versions. The current version is 0.6.1, which was released in August 2015. Between these versions, many changes and improvements have been made to <italic>CrystFEL</italic>, not only as a result of developments in SFX data processing techniques, but also to improve the user interface, stability and consistency. <italic>CrystFEL</italic> is a free and open-source software project, meaning that contributions in the form of changes to the source code can easily be made from outside the core group of developers. This has already taken place several times since <italic>CrystFEL</italic> was first published, and such contributions are actively encouraged.</p><p>The purpose of this article is to describe some of the most important changes between versions 0.3.0 and 0.6.1 of <italic>CrystFEL</italic>. &#x000a7;2<xref ref-type="sec" rid="sec2"/> of this article describes the changes made to the range of programs included in the suite, and &#x000a7;3<xref ref-type="sec" rid="sec3"/> concerns a technical improvement to <italic>CrystFEL</italic>&#x02019;s way of handling input data. The remaining sections are directly related to the issues of data quality in serial crystallography, an area that has seen very rapid development in the past few years. One aspect of this is the ability to resolve &#x02018;indexing ambiguities&#x02019;, which have been a problem since the very first SFX experiments (Chapman <italic>et&#x000a0;al.</italic>, 2011<xref ref-type="bibr" rid="bb6"> &#x025b8;</xref>). The algorithm available in <italic>CrystFEL</italic> for this purpose is slightly different from those previously described in the literature, and therefore it is described in detail in &#x000a7;4<xref ref-type="sec" rid="sec4"/>. &#x000a7;&#x000a7;5<xref ref-type="sec" rid="sec5"/> and 6<xref ref-type="sec" rid="sec6"/> describe progress in modelling the underlying diffraction process more accurately, which results in an improvement to the final merged data quality.</p></sec><sec id="sec2"><label>2.</label><title>Changes to the available programs &#x000a0; </title><p>Six new programs have been added to the <italic>CrystFEL</italic> suite, and two have been removed. The following programs are new:</p><p>
<italic>ambigator</italic>, a program for resolving indexing ambiguities, described in &#x000a7;4<xref ref-type="sec" rid="sec4"/>.</p><p>
<italic>cell_explorer</italic>, a graphical tool for unit-cell determination. A run of <italic>indexamajig</italic> without the unit-cell matching procedure (White <italic>et&#x000a0;al.</italic>, 2012<xref ref-type="bibr" rid="bb32"> &#x025b8;</xref>) produces a list of unit-cell parameters independently determined from each one of the diffraction patterns. The program <italic>cell_explorer</italic> displays histograms for <italic>a</italic>, <italic>b</italic>, <italic>c</italic>, &#x003b1;, &#x003b2; and &#x003b3; which the user can zoom and drag as well as allowing the size of the histogram bins to be altered. Different centring types are represented by colour. The user can select a range for any of the parameters, in which case the other histograms will change to highlight only the crystals having the parameter within the specified range. A Gaussian function can be fitted to the distribution of parameters within the selected range (as shown in Fig. 1<xref ref-type="fig" rid="fig1"> &#x025b8;</xref>). In this way, quantitative values including error estimates can be calculated for the cell parameters even in the presence of large amounts of contamination from incorrectly indexed patterns, contamination with other crystal forms and alternative indexing options for the same lattice.</p><p>
<italic>geoptimiser</italic>, a tool for automatically refining multi-panel detector geometry by comparing observed peak locations with the positions calculated for reflections after indexing. The algorithm is broadly similar to that described by Hattne <italic>et&#x000a0;al.</italic> (2014<xref ref-type="bibr" rid="bb12"> &#x025b8;</xref>), but additionally allows the possibility of refining in-plane rotations and out-of-plane shifts. This tool is described in detail elsewhere (Yefanov <italic>et&#x000a0;al.</italic>, 2015<xref ref-type="bibr" rid="bb34"> &#x025b8;</xref>).</p><p>
<italic>list_events</italic>, a tool for manipulating lists of diffraction patterns as input for <italic>indexamajig</italic>, described in &#x000a7;3<xref ref-type="sec" rid="sec3"/>.</p><p>
<italic>partial_sim</italic>, a simulation tool which complements <italic>pattern_sim</italic> by calculating partial reflection intensities using a geometrical model of Bragg diffraction. This program was described earlier (White <italic>et&#x000a0;al.</italic>, 2013<xref ref-type="bibr" rid="bb31"> &#x025b8;</xref>; White, 2014<xref ref-type="bibr" rid="bb30"> &#x025b8;</xref>).</p><p>
<italic>whirligig</italic>, which analyses <italic>CrystFEL</italic> output &#x02018;streams&#x02019; and searches for runs of crystals in similar orientations. This tool is intended for use in experiments similar to that described by Gati <italic>et&#x000a0;al.</italic> (2014<xref ref-type="bibr" rid="bb9"> &#x025b8;</xref>), in which diffraction patterns were acquired while performing helical scans of a grid containing microcrystals. A helical scan, as its name suggests, couples rotation of the grid with its linear translation in a particular direction. Wedges of data were identified as coming from single crystals if the orientations of adjacent crystals, as determined by <italic>CrystFEL</italic>, were similar. These wedges were then used for further processing using conventional rotation-data integration software, thereby taking advantage of both the &#x02018;serial&#x02019; and &#x02018;rotation&#x02019; aspects of data collection.</p><p>The following programs also existed in previous versions:</p><p>
<italic>check_hkl</italic>, which calculates figures of merit based on a single set of reflection data, such as mean <inline-formula><inline-graphic xlink:href="j-49-00680-efi1.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> values and completeness.</p><p>
<italic>compare_hkl</italic>, which calculates figures of merit based on two sets of reflection data, such as <italic>R</italic> factors and correlation coefficients.</p><p>
<italic>get_hkl</italic>, which is a tool for performing a variety of less common manipulations on reflection data such as expanding symmetry equivalents or adding noise for test purposes.</p><p>
<italic>hdfsee</italic>, an image viewer that works with <italic>CrystFEL</italic>&#x02019;s understanding of image data and detector geometry (see &#x000a7;3<xref ref-type="sec" rid="sec3"/>).</p><p>
<italic>indexamajig</italic>, the main indexing and integration tool.</p><p>
<italic>partialator</italic>, a program for merging reflection data with scaling and post-refinement. This program is described further in &#x000a7;6<xref ref-type="sec" rid="sec6"/>.</p><p>
<italic>pattern_sim</italic>, a program for simulating image data.</p><p>
<italic>process_hkl</italic>, a program for merging reflection data using less sophisticated methods than <italic>partialator</italic> (also described in &#x000a7;6<xref ref-type="sec" rid="sec6"/>).</p><p>
<italic>render_hkl</italic>, which renders the intensities of reflections in sections through reciprocal space.</p><p>The programs <italic>sum_stack</italic> and <italic>powder_plot</italic>, which were available in previous versions, were removed from <italic>CrystFEL</italic>. These programs, respectively, added detector frames to form a &#x02018;virtual powder pattern&#x02019; and calculated one-dimensional line profiles from them. We found that their functionality fits more logically in the &#x02018;hit-finding&#x02019; software, as described in the next section.</p></sec><sec id="sec3"><label>3.</label><title>&#x02018;Multi-event&#x02019; input files &#x000a0; </title><p>Recent advances in crystallography, including but not limited to the development of serial crystallography, have brought with them the challenges of managing large datasets. In many types of serial crystallography experiment including the &#x02018;injector-based&#x02019; approach (Chapman <italic>et&#x000a0;al.</italic>, 2011<xref ref-type="bibr" rid="bb6"> &#x025b8;</xref>), the detector is read out repeatedly as crystals are moved into the path of the X-ray beam. As a result, not every image read out from the detector contains a crystal diffraction pattern. To reduce the data volume, and also to convert the image data from any facility-specific data format to a common format, a &#x02018;hit-finding&#x02019; stage is first performed in which the crystal diffraction patterns are identified and written to new files. Software able to perform this task includes <italic>Cheetah</italic> (Barty <italic>et&#x000a0;al.</italic>, 2014<xref ref-type="bibr" rid="bb2"> &#x025b8;</xref>) and <italic>CASS</italic> (Foucar <italic>et&#x000a0;al.</italic>, 2012<xref ref-type="bibr" rid="bb8"> &#x025b8;</xref>). <italic>CrystFEL</italic> has been designed to read data after this type of processing, which has the added benefit of freeing <italic>CrystFEL</italic> from dependence on facility-specific frameworks necessary to access the original data streams (Damiani <italic>et al.</italic>, 2016<xref ref-type="bibr" rid="bb40"> &#x025b8;</xref>).</p><p>Much of the FEL data analysis &#x02018;ecosystem&#x02019; (which includes applications aside from crystallography, such as spectroscopy and coherent diffractive imaging) has been standardized on the Hierarchical Data Format version 5 (HDF5; <ext-link ext-link-type="uri" xlink:href="http://www.hdfgroup.org/HDF5/">http://www.hdfgroup.org/HDF5/</ext-link>) as a facility-independent data interchange format. <italic>CrystFEL</italic>, like both <italic>Cheetah</italic> and <italic>CASS</italic>, follows this convention. This format allows chunks of data, which can be scalar values or arrays of any dimensionality and size, to be organized in a tree-like structure. A single file can therefore contain the image data alongside metadata such as the X-ray wavelength and detector distance. <italic>CrystFEL</italic> has been designed from the start to avoid imposing restrictions on the exact layout of the HDF5 files. Instead, it allows the upstream processing steps performed by the facility analysis framework or hit-finding software to set the file layout, and reads a description of the data layout, as well as how the data in the file relate to pixels in physical space, from a &#x02018;geometry file&#x02019;. In this way, <italic>CrystFEL</italic> is not bound to any particular &#x02018;flavour&#x02019; of HDF5.</p><p>Since version 0.6.0, <italic>CrystFEL</italic> can accommodate HDF5 files that contain more than one detector readout event per file. Previously, each individual input file had to contain only one detector frame, resulting in a need for a very large number of small files and therefore inefficient handling by computer filing systems. With a &#x02018;multi-event&#x02019; HDF5 file, the detector frames can be grouped together into one large file, which is more efficient and easier to manipulate, transfer across networks and back up. Several possibilities for laying out a multi-event HDF5 file can be accommodated: a three-dimensional array where one dimension represents frame number and the other two the detector readout coordinates, a network of HDF5 &#x02018;groups&#x02019; (analogous to familiar filesystem directories), or a combination of the two. These two basic possibilities are illustrated alongside a more complicated one in Figs. 2<xref ref-type="fig" rid="fig2"> &#x025b8;</xref>(<italic>a</italic>)&#x02013;2<xref ref-type="fig" rid="fig2"> &#x025b8;</xref>(<italic>c</italic>). In addition, there is no longer a requirement that the data for all panels of a segmented detector are stored in the same data block (Fig. 2<xref ref-type="fig" rid="fig2"> &#x025b8;</xref>
<italic>d</italic>), allowing for more flexibility in the layout of the HDF5 file.</p><p>Our aim was to accommodate any &#x02018;reasonable&#x02019; layout, without adding too much complexity. Many formats are well accommodated by this change, including the native HDF5 layouts used by the Linac Coherent Light Source (LCLS) and SPring-8 Angstrom Compact Laser (SACLA) data acquisition systems, files output by the newest generation of fast counting detectors such as EIGER (Bernstein <italic>et&#x000a0;al.</italic>, 2014<xref ref-type="bibr" rid="bb3"> &#x025b8;</xref>), and the native format of the Coherent X-ray Imaging Data Bank (CXIDB; Maia, 2012<xref ref-type="bibr" rid="bb19"> &#x025b8;</xref>). The hit-finding program <italic>Cheetah</italic> (Barty <italic>et&#x000a0;al.</italic>, 2014<xref ref-type="bibr" rid="bb2"> &#x025b8;</xref>) can output files directly in a multi-event format based on the format used by the CXIDB. To help enable <italic>CrystFEL</italic> to be easily used on data from an even wider range of sites, we have made some tools available <italic>via</italic> the <italic>CrystFEL</italic> web site for converting CBF, MarCCD and raw image data to HDF5 format.</p><p>Whereas previously the input for <italic>indexamajig</italic> consisted of a list of individual filenames to process, the input can now consist of a much smaller list of files, since each file can now contain very large numbers of frames. The new program <italic>list_events</italic> can expand the short list of multi-event files into a much longer list of &#x02018;event descriptors&#x02019;. This list can then be filtered, sorted or otherwise modified to provide the input for <italic>indexamajig</italic>, which can then process only the events of interest instead of the entire dataset. The list of events could also be used as a basis for a splitting list for <italic>partialator</italic> (&#x000a7;6<xref ref-type="sec" rid="sec6"/>).</p></sec><sec id="sec4"><label>4.</label><title>Resolution of indexing ambiguities &#x000a0; </title><p>Indexing ambiguities were a significant problem in serial femtosecond crystallography for the first few years. Certain crystal symmetries permit multiple ways of indexing the lattice which are not equivalent with respect to the true symmetry of the intensities. The situations that permit this include the cases where twinning is possible by merohedry with a rotational twin law, as well as several other cases that occur if the metric symmetry happens to be higher than the true symmetry (White <italic>et&#x000a0;al.</italic>, 2013<xref ref-type="bibr" rid="bb31"> &#x025b8;</xref>). In principle, it should be possible to make the correct indexing assignment for each crystal by comparing intensities, but early attempts at simple algorithms based on this idea were not successful. Recently, Brehm &#x00026; Diederichs (2014<xref ref-type="bibr" rid="bb4"> &#x025b8;</xref>) described a working algorithm for resolving the ambiguity. The algorithm was first demonstrated on the very first SFX dataset, from photosystem I (Chapman <italic>et&#x000a0;al.</italic>, 2011<xref ref-type="bibr" rid="bb6"> &#x025b8;</xref>) as processed using a very early version of <italic>CrystFEL</italic>, and worked well despite the low resolution of the data and primitive processing.</p><p>In <italic>CrystFEL</italic>, a simpler algorithm related to this one has been implemented. It also uses a clustering approach, but in only one dimension rather than two as described previously (Brehm &#x00026; Diederichs, 2014<xref ref-type="bibr" rid="bb4"> &#x025b8;</xref>). It is related to <italic>k</italic>-means clustering (Mac&#x000ad;Queen, 1967<xref ref-type="bibr" rid="bb18"> &#x025b8;</xref>) and is similar to the selective breeding method of Kabsch (2014<xref ref-type="bibr" rid="bb14"> &#x025b8;</xref>). The algorithm is as follows:</p><p>(1) A random indexing assignment is made for each crystal.</p><p>(2) The correlation coefficient between the intensities for each pair of crystals is calculated.</p><p>(3) For each crystal in turn</p><p>(<italic>a</italic>) the mean of correlation coefficients between this crystal&#x02019;s intensities and the intensities of all other crystals with the same indexing assignment, <italic>f</italic>, is calculated,</p><p>(<italic>b</italic>) the mean of correlation coefficients between this crystal&#x02019;s intensities and the intensities of all other crystals with the opposite indexing assignment, <italic>g</italic>, is calculated, and</p><p>(<italic>c</italic>) the indexing assignment of the current pattern is swapped if <italic>g</italic> &#x0003e; <italic>f</italic>.</p><p>(4) Step 3 is repeated, looping back to the first crystal once the last one has been processed, until the indexing assignments no longer change.</p><p>Two sets of reflection intensities from crystals will always exhibit a positive correlation coefficient, provided they cover a large enough resolution range. This is because low-resolution reflections are always the strongest and high-resolution reflections always the weakest, even if the two sets of intensities come from otherwise completely unrelated orientations. To account for this, the correlation coefficients are calculated for a restricted resolution range such as 40&#x02005;&#x000c5; up to 4&#x02005;&#x000c5;. This resolution range must be set by the user, since the optimum range varies for each dataset.</p><p>As with the previous algorithm, <italic>a priori</italic> knowledge of the actual reindexing operation is not required. The algorithm sorts the individual partial datasets from each crystal into two groups with strong intra-group correlation but low inter-group correlation. However, if the reindexing transformation is known (or can be guessed, as is usually the case), the effectiveness can be improved by including in <italic>f</italic> all of the correlation coefficients between the current crystal and the other crystals with the opposite indexing assignment, after reindexing the reflections of the other crystals according to the ambiguity operation.</p><p>This algorithm is implemented in the new program <italic>ambigator</italic>, which was added to <italic>CrystFEL</italic> in version 0.5.3. The <italic>ambigator</italic> program starts from the data &#x02018;stream&#x02019; as produced by <italic>indexamajig</italic> and outputs a new stream in which the reflections have been reindexed correctly. The calculation of correlation coefficients is the most computationally intensive part of the procedure and is performed by a user-specified number of threads in parallel to accelerate it. If the number of crystals is large, it is not usually necessary to compute all correlation coefficients to resolve the indexing ambiguity: the user can specify a maximum number of correlation coefficients per crystal. Doing so essentially reduces the complexity of the algorithm from <inline-formula><inline-graphic xlink:href="j-49-00680-efi2.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> to <inline-formula><inline-graphic xlink:href="j-49-00680-efi3.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>, where <italic>N</italic> is the number of crystals. The program usually executes in a small number of minutes for a typical SFX dataset of around 10&#x02005;000 crystals on a current desktop computer. The program also offers the option of saving the matrix of correlation coefficients in HDF5 format, for use in analysis methods such as hierarchical clustering (Zeldin <italic>et&#x000a0;al.</italic>, 2015<xref ref-type="bibr" rid="bb35"> &#x025b8;</xref>).</p><p>Some systems, notably those in space groups <italic>P</italic>3, <inline-formula><inline-graphic xlink:href="j-49-00680-efi4.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> and <inline-formula><inline-graphic xlink:href="j-49-00680-efi5.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>, exhibit two indexing ambiguities instead of just one. The two indexing ambiguities lead to a total of four possible indexing assignments. Whereas the previous algorithms handled this situation by clustering the data in three dimensions instead of two, the new algorithm can only be applied to one ambiguity at a time. Nevertheless, the situation can still be handled by running the algorithm twice, first to resolve one of the two ambiguities, then again on the reindexed results from the first run, this time resolving the second ambiguity and hence distinguishing between the four possible indexing assignments.</p><p>The algorithm as implemented in <italic>ambigator</italic> has been tested on the original data stream from the very first SFX dataset (Chapman <italic>et&#x000a0;al.</italic>, 2011<xref ref-type="bibr" rid="bb6"> &#x025b8;</xref>), <italic>i.e.</italic> directly using the results of the original indexing and integration which was performed for this experiment. After a simple text reformatting operation, the data stream from the very early version of <italic>CrystFEL</italic> could be used directly by <italic>CrystFEL</italic> version 0.6.1. Fig. 3<xref ref-type="fig" rid="fig3"> &#x025b8;</xref> shows the resulting correlation coefficients. In this graph, orange and blue points, respectively, represent the values of <italic>f</italic> and <italic>g</italic> for the crystal being considered in step 3 of the algorithm. At the start of the process (the left-hand edge of the graph), the orange and blue points overlap with one another. As the algorithm progresses, it visits each crystal in the dataset before starting again from the first crystal, passing over each crystal three times in this case. As would be expected for correct indexing assignments, the values of <italic>f</italic> become systematically higher than those of <italic>g</italic>, both for each individual crystal and in their overall values. The orange and blue points therefore separate into two clusters, which can be seen as the almost complete separation of the orange points from the blue points at the right-hand end of the graph.</p><p>The success of this approach probably lies in the fact that it considers the mean of the correlation coefficients between each set of intensities and many other sets, rather than considering only one such correlation coefficient against a reference set of intensities. We have not found it to be necessary to interleave this algorithm with rounds of other data quality enhancements such as scaling or post-refinement as described below &#x02014; a single run of the algorithm on the integrated intensities, prior to merging with scaling, is sufficient. The restriction of the resolution range over which the correlation coefficients are calculated also appears to be an important contribution to a successful resolution of an indexing ambiguity.</p></sec><sec id="sec5"><label>5.</label><title>Prediction refinement &#x000a0; </title><p>The final two sections of this article concern modelling the diffraction processes that relate the crystal structure factors to the intensities of the spots observed in the diffraction pattern. Factors that affect this relationship include the intensity of the incident X-ray beam, the size and quality of the crystal, the polarization of the incident and diffracted X-ray beams, the partiality of each reflection (Rossmann <italic>et&#x000a0;al.</italic>, 1979<xref ref-type="bibr" rid="bb23"> &#x025b8;</xref>), effects from fast ionization dynamics (Son &#x00026; Santra, 2011<xref ref-type="bibr" rid="bb26"> &#x025b8;</xref>), the energy spectrum of the incident X-ray beam, and the response of the detector. Correctly modelling these factors and then compensating for them, for example by using a linear scaling factor to account for variations in the incident beam intensity, should reduce the variance of the intensity measurements for a particular reflection and hence result in more precise merged intensities. Equivalently, this should allow a smaller number of crystals to be used to achieve an acceptable level of precision. This has been a very active field in the few years that have passed since the first SX experiments. The enhancements described include refinement of the crystal parameters prior to integration (Sauter <italic>et&#x000a0;al.</italic>, 2014<xref ref-type="bibr" rid="bb25"> &#x025b8;</xref>; Ginn, Messer&#x000ad;schmidt <italic>et&#x000a0;al.</italic>, 2015<xref ref-type="bibr" rid="bb11"> &#x025b8;</xref>), an accurate refinement of the detector geometry (Ginn, Brewster <italic>et&#x000a0;al.</italic>, 2015<xref ref-type="bibr" rid="bb10"> &#x025b8;</xref>; Yefanov <italic>et&#x000a0;al.</italic>, 2015<xref ref-type="bibr" rid="bb34"> &#x025b8;</xref>), outlier rejection (Ginn, Brewster <italic>et&#x000a0;al.</italic>, 2015<xref ref-type="bibr" rid="bb10"> &#x025b8;</xref>), scaling of the reflection data including both linear and Debye&#x02013;Waller terms (Sauter, 2015<xref ref-type="bibr" rid="bb24"> &#x025b8;</xref>; Uervirojnangkoorn <italic>et&#x000a0;al.</italic>, 2015<xref ref-type="bibr" rid="bb29"> &#x025b8;</xref>), and the inclusion of reflection partiality. All these improvements are implemented within <italic>CrystFEL</italic>.</p><p>The first method proposed for SFX data analysis involved the selection of pixels to integrate based on the proximity of the corresponding location in reciprocal space, under the assumption of a monochromatic X-ray beam, to a reciprocal lattice point (Kirian <italic>et&#x000a0;al.</italic>, 2010<xref ref-type="bibr" rid="bb15"> &#x025b8;</xref>). This was referred to as the &#x02018;Monte Carlo&#x02019; integration method. Since the very first released version of <italic>CrystFEL</italic> (version 0.3.0), integration has been performed using a more conventional method in which a shoe box summation with a fixed radius in pixels is performed around the &#x02018;predicted&#x02019; reflection location (White <italic>et&#x000a0;al.</italic>, 2013<xref ref-type="bibr" rid="bb31"> &#x025b8;</xref>). More recent versions of <italic>CrystFEL</italic> include two-dimensional profile fitting (Rossmann, 1979<xref ref-type="bibr" rid="bb22"> &#x025b8;</xref>) as an optional alternative method for spot integration. No version of <italic>CrystFEL</italic> has, by default, used the Monte Carlo integration method exactly as it was initially described, although it was available as an option in versions prior to the first generally released version. Nevertheless, we use the term &#x02018;Monte Carlo&#x02019; to refer to the process of merging reflection intensities without accounting for the complicated relationship between the crystal structure factors and the intensities observed in the diffraction patterns.</p><p>Before version 0.6.1, <italic>CrystFEL</italic>&#x02019;s indexing and integration program <italic>indexamajig</italic> accepted the indexing solution from the indexing programs [initially <italic>DirAx</italic> (Duisenberg, 1992<xref ref-type="bibr" rid="bb7"> &#x025b8;</xref>) and <italic>MOSFLM</italic> (Powell <italic>et&#x000a0;al.</italic>, 2013<xref ref-type="bibr" rid="bb21"> &#x025b8;</xref>), but now also including <italic>XDS</italic> (Kabsch, 1988<xref ref-type="bibr" rid="bb13"> &#x025b8;</xref>) and a new algorithm known as &#x02018;asdf&#x02019; built into <italic>CrystFEL</italic> itself] and used it directly to calculate the spot locations for integration. Even if the Monte Carlo merging method is used, in which most of the factors affecting the diffracted intensity are neglected, a model is still required to choose (or &#x02018;predict&#x02019;) which reflections appear in the diffraction pattern. Effectively, reflections that should be excited according to the model are assigned partialities of 1 and all others are assigned 0. Calculating more accurate partialities could therefore be considered as a more advanced way of making this selection of reflections. One way to do this is by minimizing a residual based on the intensities themselves, which is the classic &#x02018;post-refinement&#x02019; method (Rossmann <italic>et&#x000a0;al.</italic>, 1979<xref ref-type="bibr" rid="bb23"> &#x025b8;</xref>) and has been described several times in relation to SX data (White, 2014<xref ref-type="bibr" rid="bb30"> &#x025b8;</xref>; Kabsch, 2014<xref ref-type="bibr" rid="bb14"> &#x025b8;</xref>; Sauter, 2015<xref ref-type="bibr" rid="bb24"> &#x025b8;</xref>; Uervirojnangkoorn <italic>et&#x000a0;al.</italic>, 2015<xref ref-type="bibr" rid="bb29"> &#x025b8;</xref>; Ginn, Brewster <italic>et&#x000a0;al.</italic>, 2015<xref ref-type="bibr" rid="bb10"> &#x025b8;</xref>; Kroon-Batenburg <italic>et&#x000a0;al.</italic>, 2015<xref ref-type="bibr" rid="bb16"> &#x025b8;</xref>). Another method to improve the selection of reflections is by minimizing a residual involving the reflection positions relative to observed spots and their distance from the exact Bragg condition (Kabsch, 2014<xref ref-type="bibr" rid="bb14"> &#x025b8;</xref>; Ginn, Messerschmidt <italic>et&#x000a0;al.</italic>, 2015<xref ref-type="bibr" rid="bb11"> &#x025b8;</xref>; Sauter <italic>et&#x000a0;al.</italic>, 2014<xref ref-type="bibr" rid="bb25"> &#x025b8;</xref>). A combination of the two methods is possible, as was described by Sauter (2015<xref ref-type="bibr" rid="bb24"> &#x025b8;</xref>) and Uervirojnangkoorn <italic>et&#x000a0;al.</italic> (2015<xref ref-type="bibr" rid="bb29"> &#x025b8;</xref>), but the two methods are kept separate in <italic>CrystFEL</italic>, where the second method is known as &#x02018;prediction refinement&#x02019; because it is concerned with optimizing the prediction of reflections prior to integration.</p><p>In <italic>CrystFEL</italic>, prediction refinement is performed by first selecting the observed spots that correspond to the crystal lattice, excluding those which arise from other overlapping diffraction patterns or other sources. This is performed by calculating the closest integral Miller indices for each spot using the basis vectors of the lattice (even if the indices are very far from integral values), then calculating the predicted location for that reflection in the pattern and including only those which fall within ten pixels of the observed spot. This is followed by sorting the reflections into order of increasing values of the mean of the upper and lower &#x02018;excitation error&#x02019; values, <italic>r</italic> (White, 2014<xref ref-type="bibr" rid="bb30"> &#x025b8;</xref>). The list is then passed over, and the gradient <inline-formula><inline-graphic xlink:href="j-49-00680-efi6.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> calculated for each reflection <italic>i</italic>. Each reflection <italic>j</italic> with <inline-formula><inline-graphic xlink:href="j-49-00680-efi7.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> is then examined in turn, in order of increasing <inline-formula><inline-graphic xlink:href="j-49-00680-efi8.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>, and the list truncated at the first reflection for which<disp-formula id="fd1"><graphic xlink:href="j-49-00680-efd1.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>This procedure essentially finds the first abrupt increase of <italic>r</italic>, which appears to herald the end of the correct spot&#x02013;reflection pairings, and filters out outlying points in a robust manner.</p><p>Once the spots have been selected, the following residual is minimized in a nonlinear least-squares procedure which varies the lattice basis vectors and the centre of the diffraction pattern on the detector:<disp-formula id="fd2"><graphic xlink:href="j-49-00680-efd2.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>Here, <inline-formula><inline-graphic xlink:href="j-49-00680-efi9.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> and <inline-formula><inline-graphic xlink:href="j-49-00680-efi10.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> are the positions of an observed spot on the detector in the laboratory coordinate system, <inline-formula><inline-graphic xlink:href="j-49-00680-efi11.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> and <inline-formula><inline-graphic xlink:href="j-49-00680-efi12.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> are the positions of the spot as predicted by the diffraction model, <inline-formula><inline-graphic xlink:href="j-49-00680-efi13.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> is the mean of the upper and lower &#x02018;excitation error&#x02019; values for the reflection, <inline-formula><inline-graphic xlink:href="j-49-00680-efi14.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> is the intensity of the spot divided by the maximum spot intensity found in the pattern, and <inline-formula><inline-graphic xlink:href="j-49-00680-efi15.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>. The weighting factor is needed to bring the contributions from excitation error (which is measured in reciprocal metres and has order of magnitude <inline-formula><inline-graphic xlink:href="j-49-00680-efi16.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>) and spot position (which is measured in metres and has order of magnitude <inline-formula><inline-graphic xlink:href="j-49-00680-efi17.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>) onto approximately the same scale.</p><p>This minimization takes very little additional time and has been found to improve the self-consistency figure of merit <inline-formula><inline-graphic xlink:href="j-49-00680-efi18.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> on its own (see &#x000a7;6<xref ref-type="sec" rid="sec6"/>). The updated beam centre positions generated for each crystal are stored in the data stream and can be used to update the detector geometry in addition to the main geometry refinement tool <italic>geoptimiser</italic> (Yefanov <italic>et&#x000a0;al.</italic>, 2015<xref ref-type="bibr" rid="bb34"> &#x025b8;</xref>). Fig. 4<xref ref-type="fig" rid="fig4"> &#x025b8;</xref> shows the required offsets for a previously published dataset for the 5-<inline-formula><inline-graphic xlink:href="j-49-00680-efi19.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> receptor (Liu <italic>et&#x000a0;al.</italic>, 2013<xref ref-type="bibr" rid="bb17"> &#x025b8;</xref>), which in this case shows a clear offset corresponding to 2.6 pixels. This plot was calculated using the results of indexing with a target unit cell, but the updated beam centre positions have useful values even on an initial indexing run without reference lattice parameters.</p><p>The diffraction model in current versions of <italic>CrystFEL</italic> has been described previously (White <italic>et&#x000a0;al.</italic>, 2013<xref ref-type="bibr" rid="bb31"> &#x025b8;</xref>; White, 2014<xref ref-type="bibr" rid="bb30"> &#x025b8;</xref>). It makes use of several parameters for selecting reflections: the beam convergence angle, the bandwidth of the X-ray beam and a notional &#x02018;size&#x02019; of the scattering density that surrounds each reciprocal lattice point (&#x02018;reciprocal space profile radius&#x02019;). These parameters can be set manually if accurate values are known; otherwise the convergence angle and bandwidth are set to small values and the profile radius is determined automatically as follows. First, reflections arising from the crystal are selected as described above. Then, the reciprocal space profile radius is set such that 98% of the spots that were assigned indices are predicted. Despite having no component that varies significantly with increasing resolution, we have found that this method gives good matches with the observed spots in most cases. The method could easily be extended to optimize other parameters such as the bandwidth, beam convergence angle or crystal mosaicity.</p><p>Another method was recently described for a similar refinement in which the reciprocal space profile radius was minimized directly by adjusting the orientation (Ginn, Messerschmidt <italic>et&#x000a0;al.</italic>, 2015<xref ref-type="bibr" rid="bb11"> &#x025b8;</xref>). It can easily be demonstrated that the prediction refinement step has a similar effect by comparing the profile radii before and after the refinement, both of which are stored in the data stream. For the 5-<inline-formula><inline-graphic xlink:href="j-49-00680-efi19.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> data mentioned above, the radius was reduced for the majority (68%) of crystals, and for nearly half (48%) of them the radius was reduced by more than 10%.</p><p>Finally, since version 0.5.3, <italic>CrystFEL</italic> automatically attempts to estimate the resolution to which each crystal diffracts. For this purpose <italic>CrystFEL</italic> considers a spot to be accounted for by a lattice if the Miller indices calculated for the spot using the basis vectors are within 0.25 of integral values. The 98th percentile of the scattering angles of these spots is then taken as a conservative estimate of the resolution limit. <italic>CrystFEL</italic> offers the option of restricting integration to reflections lower than the limit, or extending to a resolution limit higher by a user-specified value (which can even be negative to restrict the resolution further, if required). This cutoff can be performed equally well at the integration or merging stages. Performing the cutoff at the integration stage results in a much smaller output data stream and therefore increases the speed of later processing, whereas performing it at the merging stage allows different scenarios to be explored without repeating the whole integration stage. We have found this method of estimating the resolution to be very robust, and it has increased the quality of the resulting density maps in some cases (Zhang <italic>et&#x000a0;al.</italic>, 2015<xref ref-type="bibr" rid="bb36"> &#x025b8;</xref>). The default behaviour is for no resolution cutoff to be applied. Regardless of whether or not the user opts to actually perform the resolution cutoff, the conservative estimated resolution is written into the output data stream, allowing datasets to be quickly and meaningfully compared.</p><p>The overall flow of the processing of a single frame of data by <italic>indexamajig</italic> is shown in Fig. 5<xref ref-type="fig" rid="fig5"> &#x025b8;</xref>, which can be compared with the flow diagram for earlier versions (White <italic>et&#x000a0;al.</italic>, 2012<xref ref-type="bibr" rid="bb32"> &#x025b8;</xref>). The information from the peak search is used in almost all stages after indexing, with the notable exception of the final prediction and integration stage, which is performed from scratch using the diffraction model constructed and refined in the earlier stages.</p></sec><sec id="sec6"><label>6.</label><title>Scaling and post-refinement &#x000a0; </title><p>Since the first release version, <italic>CrystFEL</italic> has offered two programs for merging individual reflection intensities into a final dataset which can be exported and used for the subsequent stages of structural analysis. The first is <italic>process_hkl</italic>, which implements a relatively simple merging strategy that takes the average of the individual intensity measurements for each symmetrically unique reflection, after applying corrections for polarization of the incident and diffracted beams. It offers an option for scaling of the intensities that is performed by merging the data twice, the second time multiplying each intensity by the scale factor which gives the best fit to the merged intensities determined on the first pass.</p><p>The second merging program is <italic>partialator</italic>, which has much greater capabilities including a more advanced scaling algorithm based on multiple passes over the data. It also offers the possibility of carrying out partiality correction and post-refinement. In versions of <italic>CrystFEL</italic> prior to 0.6.1, none of the algorithms in <italic>partialator</italic> were sufficiently stable to be applied to real experimental data, although they worked for demonstration purposes on simulated data (White, 2014<xref ref-type="bibr" rid="bb30"> &#x025b8;</xref>). As of version 0.6.1, the scaling and merging algorithms in <italic>partialator</italic> have been improved and are now recommended for routine use on real data, having been tested on many datasets. The partiality correction and post-refinement algorithms continue to be under development.</p><p>The scaling of reflection intensities in <italic>partialator</italic> is achieved using least-squares minimization on a logarithmic residual, as for the procedure described by Kabsch (2014<xref ref-type="bibr" rid="bb14"> &#x025b8;</xref>). The algorithm starts by merging the intensities from all crystals to make a &#x02018;reference&#x02019; dataset. Then, for each pattern, the residual to be minimized is<disp-formula id="fd3"><graphic xlink:href="j-49-00680-efd3.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>Here <inline-formula><inline-graphic xlink:href="j-49-00680-efi21.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> is the intensity of the reflection as measured from the diffraction pattern after polarization correction, <italic>G</italic> and <italic>B</italic> are the linear and Debye&#x02013;Waller scaling terms, respectively, <italic>L</italic> is the Lorentz factor (currently set to 1), <italic>p</italic> is the estimated partiality of the reflection, <inline-formula><inline-graphic xlink:href="j-49-00680-efi22.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> is the merged intensity of reflection, <inline-formula><inline-graphic xlink:href="j-49-00680-efi23.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> is a weighting factor (also set to 1), and <inline-formula><inline-graphic xlink:href="j-49-00680-efi24.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>, where &#x003b8; is half the scattering angle and &#x003bb; is the X-ray wavelength. The sum is over all reflections from one crystal in one snapshot, and minimization is performed by varying <italic>G</italic> and <italic>B</italic>. The advantages of a logarithmic residual are that it improves the numerical stability of the algorithm because very small values of <inline-formula><inline-graphic xlink:href="j-49-00680-efi25.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> are avoided, weights reflections approximately equally across the whole resolution range despite very large variations in intensity, and guarantees that the resulting value of <italic>G</italic> will be positive. A special consideration when using the logarithmic residual is that reflections with zero or negative values of <inline-formula><inline-graphic xlink:href="j-49-00680-efi21.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> or <inline-formula><inline-graphic xlink:href="j-49-00680-efi22.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> cannot be included.</p><p>The least-squares minimization is linear in both <inline-formula><inline-graphic xlink:href="j-49-00680-efi28.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> and <italic>B</italic> and can therefore be performed in one iteration per crystal. Crystals with <inline-formula><inline-graphic xlink:href="j-49-00680-efi29.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>&#x02005;&#x000c5;<sup>2</sup> are rejected, although this cutoff can be changed by the user if required. Once the best values have been determined for all crystals, the intensities from all crystals are merged once more to produce an updated reference dataset, and the process is repeated a user-specified number of times. If the number of parameters to be refined exceeds the number of reflections included in the refinement calculation for any crystal, that crystal is excluded from all further processing.</p><p>Fig. 6<xref ref-type="fig" rid="fig6"> &#x025b8;</xref> shows the value of the self-consistency figure of merit CC<inline-formula><inline-graphic xlink:href="j-49-00680-efi30.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> for four cases of data processing applied to a previously published dataset (Liu <italic>et&#x000a0;al.</italic>, 2013<xref ref-type="bibr" rid="bb17"> &#x025b8;</xref>): prediction refinement only, scaling only, both and neither. Reflections containing any pixel with a value higher than 14&#x02005;000 detector units before background subtraction, the approximate saturation value of the detector used for this experiment, were excluded. Reflections were merged up to 0.3&#x02005;nm<sup>&#x02212;1</sup> above the conservatively estimated resolution limit for each crystal. Where scaling was used, three iterations of scaling were performed. Partiality modelling and post-refinement were not performed, <italic>i.e.</italic> partialities were fixed as 1 for all reflections. The number of crystals used in each case varies because of different rejection criteria: 2081 crystals were included for &#x02018;Neither&#x02019;, 2007 for &#x02018;Prediction refinement only&#x02019;, 1617 for &#x02018;Scaling only&#x02019; and 1422 for &#x02018;Prediction refinement and scaling&#x02019;. When prediction refinement is used, which is the default in <italic>CrystFEL</italic> since version 0.6.1 but can be disabled if required, crystals are rejected if fewer than ten spots could be assigned indices as described above. When scaling is used, crystals are rejected if <italic>B</italic> is too large, as also described above. Despite the decreasing number of crystals, CC<inline-formula><inline-graphic xlink:href="j-49-00680-efi30.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> increases as the more sophisticated analysis schemes are applied. The improvement occurs across all resolution shells, and the apparent resolution of the data, as judged by the point where CC<inline-formula><inline-graphic xlink:href="j-49-00680-efi30.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> falls off very rapidly, increases by about 0.5&#x02005;&#x000c5;. The overall CC<inline-formula><inline-graphic xlink:href="j-49-00680-efi30.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> increases from 0.878 for processing without prediction refinement and scaling, through 0.921 for prediction refinement alone, to 0.957 for prediction refinement and scaling combined.</p><p>In addition to scaling, <italic>partialator</italic> implements post-refinement as previously described (White, 2014<xref ref-type="bibr" rid="bb30"> &#x025b8;</xref>). So far we have found the improvements from this to be small and counteracted by crystals being rejected as a result of the post-refinement calculation diverging. However, the improvements from the prediction refinement and scaling shown here compare favourably with the results found by other authors for partiality-based analysis schemes applied to SFX data. Sauter (2015<xref ref-type="bibr" rid="bb24"> &#x025b8;</xref>) found an improvement of CC<inline-formula><inline-graphic xlink:href="j-49-00680-efi30.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> from 0.872 to 0.902 with 12&#x02005;550 crystals when moving from a scheme similar to <italic>CrystFEL</italic>&#x02019;s prediction refinement to one including individual <italic>B</italic> factors, partiality correction and post-refinement. Uervirojnangkoorn <italic>et&#x000a0;al.</italic> (2015<xref ref-type="bibr" rid="bb29"> &#x025b8;</xref>) found an improvement of CC<inline-formula><inline-graphic xlink:href="j-49-00680-efi30.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> from 0.777 to 0.935 with 2000 crystals of thermolysin, again when moving from a prediction refinement scheme (the one included in <italic>cctbx.xfel</italic>; Hattne <italic>et al.</italic>, 2014<xref ref-type="bibr" rid="bb12"> &#x025b8;</xref>), without scaling, to a full scaling and post-refinement scheme. Their post-refinement scheme includes individual <italic>B</italic> factors as well as aspects similar to the prediction refinement scheme presented here, but they did not report results for these intermediate stages on their own. The same authors found an improvement from 0.918 to 0.982 with 757 crystals of myoglobin when moving from <italic>cctbx.xfel</italic>&#x02019;s prediction refinement to full scaling and post-refinement, also reporting CC<inline-formula><inline-graphic xlink:href="j-49-00680-efi30.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> = 0.957 for a more rudimentary scaling scheme without individual <italic>B</italic> factors and without partiality correction and post-refinement. Ginn, Messerschmidt <italic>et&#x000a0;al.</italic> (2015<xref ref-type="bibr" rid="bb11"> &#x025b8;</xref>) found an improvement of CC<inline-formula><inline-graphic xlink:href="j-49-00680-efi30.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> from 0.972 to 0.983 when applying partiality correction to 5787 crystals of a viral polyhedrin, having already refined the orientations of the crystals and scaled (without individual <italic>B</italic> factors). Our result that the additional improvement, over that from the prediction refinement and scaling stages, from correcting partialities is small therefore appears to be compatible with the previous results. Nevertheless, we by no means exclude that our absence of large improvements with partiality-based schemes is due to a deficiency in our implementation, and expect that further improvements in the partiality correction and post-refinement algorithms in <italic>CrystFEL</italic> will lead to it making a more significant improvement. We leave this as the subject for future work, and also acknowledge that CC<inline-formula><inline-graphic xlink:href="j-49-00680-efi30.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> should not be the sole quantifier of SFX data quality.</p><p>The <italic>partialator</italic> program performs both the scaling and post-refinement steps including cross-validation similar to that commonly performed during structural refinement (Br&#x000fc;nger, 1997<xref ref-type="bibr" rid="bb5"> &#x025b8;</xref>). Five percent of the reflections in the input dataset are excluded from the least-squares minimization procedures, and the residual is calculated separately for these reflections to give a &#x02018;free residual&#x02019; which is displayed on screen. The scatter plots of &#x02018;observed&#x02019; and calculated partiality (White, 2014<xref ref-type="bibr" rid="bb30"> &#x025b8;</xref>), which can be used to visually assess the effectiveness of partiality correction and post-refinement, are also calculated using the &#x02018;free&#x02019; reflections.</p><p>Another important feature of <italic>partialator</italic> is the ability to split datasets into sections after scaling and post-refinement. This feature is intended for use when performing a time-resolved serial crystallography experiment [such as those recently described by Tenboer <italic>et&#x000a0;al.</italic> (2014<xref ref-type="bibr" rid="bb28"> &#x025b8;</xref>) and Barends <italic>et&#x000a0;al.</italic> (2015<xref ref-type="bibr" rid="bb1"> &#x025b8;</xref>)] or an isomorphous replacement experiment (Yamashita <italic>et&#x000a0;al.</italic>, 2015<xref ref-type="bibr" rid="bb33"> &#x025b8;</xref>). Here, an extra input file can be provided to <italic>partialator</italic> which gives a &#x02018;dataset identifier&#x02019; for each diffraction pattern. Diffraction patterns are identified using either the filename of the original image or the event descriptor (see &#x000a7;3<xref ref-type="sec" rid="sec3"/>). The dataset identifier can be any sequence of letters or numbers and might represent a time delay (in a time-resolved experiment) or have a value such as &#x02018;native&#x02019; or &#x02018;derivative&#x02019; (in an isomorphous replacement experiment). All crystals will be scaled and post-refined as described above, but in addition to being merged together to form an overall dataset, they will be merged separately in groups, where each group consists of crystals from images with identical dataset identifiers. Therefore, all of the datasets will be on the same scale, and any potential concerns about the uniqueness of the result of the post-refinement are greatly reduced. For each merged dataset, the crystals will also be randomly split into two half-datasets which will be merged separately. Self-consistency figures of merit for the datasets can be calculated by comparing these split&#x02013;merged datasets using <italic>compare_hkl</italic>. A pair of split&#x02013;merged half-datasets is, of course, also written for the entire dataset, regardless of whether or not the custom dataset splitting feature is used. A further advantage of this feature is that, if an indexing ambiguity exists, it can be resolved using a single run of <italic>ambigator</italic> on the entire combined stream and no further checks need to be performed.</p></sec><sec id="sec7"><label>7.</label><title>Conclusions &#x000a0; </title><p>This article has described some of the most important recent changes in <italic>CrystFEL</italic>, which together constitute a significant enhancement of the software over the first released version 0.3.0 (White <italic>et&#x000a0;al.</italic>, 2012<xref ref-type="bibr" rid="bb32"> &#x025b8;</xref>). Improvements have been made in all areas of the suite, including the user interface and data handling and analysis algorithms. All changes, including the developmental changes between versions dating all the way back to the very first lines of code, can be retrieved from the public version control repository, for which details can be found on the <italic>CrystFEL</italic> web site at <ext-link ext-link-type="uri" xlink:href="http://www.desy.de/~twhite/crystfel">http://www.desy.de/~twhite/crystfel</ext-link>.</p><p>Future work will include further improvements across the suite, in particular to develop the prediction refinement, scaling, post-refinement and diffraction modelling with the aim of fully understanding the factors affecting data quality in an SFX experiment.</p></sec></body><back><fn-group><fn id="fn1"><label>1</label><p>This article will form part of a virtual special issue of the journal on free-electron laser software.</p></fn></fn-group><ack><p>We thank all of the many users of <italic>CrystFEL</italic> who sent feedback and bug reports, and in particular Parker de Waal, Karol Nass and Nadia Zatsepin for contributing bug fixes. TAW, VM, OY, KRB, FC, LG, CG and HNC acknowledge funding from the Helmholtz Association through project oriented funds. CG sincerely thanks the PIER Helmholtz Graduate School for financial support. AT acknowledges funding from the European Union&#x02019;s 2020 Research and Innovation Programme under the Marie Sk&#x00142;odowska-Curie grant agreement <award-id>637295</award-id> (2015&#x02013;2018). TN and KY acknowledge support by the X-ray Free Electron Laser Priority Strategy Programme (MEXT, Japan) and computing support from SACLA HPC and Mini-K.</p></ack><ref-list><title>References</title><ref id="bb1"><mixed-citation publication-type="other">Barends, T. R.&#x000a0;M. <italic>et al.</italic> (2015). <italic>Science</italic>, <bold>350</bold>, 445&#x02013;450.</mixed-citation></ref><ref id="bb2"><mixed-citation publication-type="other">Barty, A., Kirian, R. A., Maia, F. R. N. C., Hantke, M., Yoon, C. H., White, T. A. &#x00026; Chapman, H. (2014). <italic>J. Appl. Cryst.</italic>
<bold>47</bold>, 1118&#x02013;1131.</mixed-citation></ref><ref id="bb3"><mixed-citation publication-type="other">Bernstein, H. J., Sloan, J. M., Winter, G., Richter, T. S., NeXus International Advisory Committee &#x00026; Committee on the Maintenance of the CIF Standard (2014). <italic>Comput. Crystallogr. Newsl.</italic>
<bold>5</bold>, 12.</mixed-citation></ref><ref id="bb4"><mixed-citation publication-type="other">Brehm, W. &#x00026; Diederichs, K. (2014). <italic>Acta Cryst.</italic> D<bold>70</bold>, 101&#x02013;109.</mixed-citation></ref><ref id="bb5"><mixed-citation publication-type="other">Br&#x000fc;nger, A. T. (1997). <italic>Methods Enzymol.</italic>
<bold>277</bold>, 366&#x02013;396.</mixed-citation></ref><ref id="bb6"><mixed-citation publication-type="other">Chapman, H. N. <italic>et al.</italic> (2011). <italic>Nature</italic>, <bold>470</bold>, 73&#x02013;77.</mixed-citation></ref><ref id="bb40"><mixed-citation publication-type="journal">Damiani, D., Dubrovin, M., Gaponenko, I., Kroeger, W., Lane, T. J., Mitra, A., O&#x02019;Grady, C. P., Salnikov, A., Sanchez-Gonzalez, A., Schneider, D. &#x00026; Yoon, C. H. (2016). <italic>J Appl. Cryst.</italic>
<bold>49</bold>, 672&#x02013;679.</mixed-citation></ref><ref id="bb7"><mixed-citation publication-type="other">Duisenberg, A. J. M. (1992). <italic>J. Appl. Cryst.</italic>
<bold>25</bold>, 92&#x02013;96.</mixed-citation></ref><ref id="bb8"><mixed-citation publication-type="other">Foucar, L., Barty, A., Coppola, N., Hartmann, R., Holl, P., Hoppe, U., Kassemeyer, S., Kimmel, N., K&#x000fc;pper, J., Scholz, M., Techert, S., White, T. A., Str&#x000fc;der, L. &#x00026; Ullrich, J. (2012). <italic>Comput. Phys. Commun.</italic>
<bold>183</bold>, 2207&#x02013;2213.</mixed-citation></ref><ref id="bb9"><mixed-citation publication-type="other">Gati, C., Bourenkov, G., Klinge, M., Rehders, D., Stellato, F., Oberth&#x000fc;r, D., Yefanov, O., Sommer, B. P., Mogk, S., Duszenko, M., Betzel, C., Schneider, T. R., Chapman, H. N. &#x00026; Redecke, L. (2014). <italic>IUCrJ</italic>, <bold>1</bold>, 87&#x02013;94.</mixed-citation></ref><ref id="bb10"><mixed-citation publication-type="other">Ginn, H. M., Brewster, A. S., Hattne, J., Evans, G., Wagner, A., Grimes, J. M., Sauter, N. K., Sutton, G. &#x00026; Stuart, D. I. (2015). <italic>Acta Cryst.</italic> D<bold>71</bold>, 1400&#x02013;1410.</mixed-citation></ref><ref id="bb11"><mixed-citation publication-type="other">Ginn, H. M., Messerschmidt, M., Ji, X., Zhang, H., Axford, D., Gildea, R. J., Winter, G., Brewster, A. S., Hattne, J., Wagner, A., Grimes, J.&#x000a0;M., Evans, G., Sauter, N. K., Sutton, G. &#x00026; Stuart, D. I. (2015). <italic>Nat. Commun.</italic>
<bold>6</bold>, 6435.</mixed-citation></ref><ref id="bb12"><mixed-citation publication-type="other">Hattne, J. <italic>et al.</italic> (2014). <italic>Nat. Methods</italic>, <bold>11</bold>, 545&#x02013;548.</mixed-citation></ref><ref id="bb13"><mixed-citation publication-type="other">Kabsch, W. (1988). <italic>J. Appl. Cryst.</italic>
<bold>21</bold>, 916&#x02013;924.</mixed-citation></ref><ref id="bb14"><mixed-citation publication-type="other">Kabsch, W. (2014). <italic>Acta Cryst.</italic> D<bold>70</bold>, 2204&#x02013;2216.</mixed-citation></ref><ref id="bb15"><mixed-citation publication-type="other">Kirian, R. A., Wang, X., Weierstall, U., Schmidt, K. E., Spence, J.&#x000a0;C.&#x000a0;H., Hunter, M., Fromme, P., White, T., Chapman, H. N. &#x00026; Holton, J. (2010). <italic>Opt. Express</italic>, <bold>18</bold>, 5713&#x02013;5723.</mixed-citation></ref><ref id="bb16"><mixed-citation publication-type="other">Kroon-Batenburg, L. M. J., Schreurs, A. M. M., Ravelli, R. B. G. &#x00026; Gros, P. (2015). <italic>Acta Cryst.</italic> D<bold>71</bold>, 1799&#x02013;1811.</mixed-citation></ref><ref id="bb17"><mixed-citation publication-type="other">Liu, W. <italic>et al.</italic> (2013). <italic>Science</italic>, <bold>342</bold>, 1521&#x02013;1524.</mixed-citation></ref><ref id="bb18"><mixed-citation publication-type="other">MacQueen, J. (1967). <italic>Proceedings of the Fifth Berkeley Symposium on Mathematical Statistics and Probability</italic>, Vol. 1, pp. 281&#x02013;297. Berkeley: University of California Press.</mixed-citation></ref><ref id="bb19"><mixed-citation publication-type="other">Maia, F. R. N. C. (2012). <italic>Nat. Methods</italic>, <bold>9</bold>, 854&#x02013;855.</mixed-citation></ref><ref id="bb20"><mixed-citation publication-type="other">Nogly, P. <italic>et al.</italic> (2015). <italic>IUCrJ</italic>, <bold>2</bold>, 168&#x02013;176.</mixed-citation></ref><ref id="bb21"><mixed-citation publication-type="other">Powell, H. R., Johnson, O. &#x00026; Leslie, A. G. W. (2013). <italic>Acta Cryst.</italic> D<bold>69</bold>, 1195&#x02013;1203.</mixed-citation></ref><ref id="bb22"><mixed-citation publication-type="other">Rossmann, M. G. (1979). <italic>J. Appl. Cryst.</italic>
<bold>12</bold>, 225&#x02013;238.</mixed-citation></ref><ref id="bb23"><mixed-citation publication-type="other">Rossmann, M. G., Leslie, A. G. W., Abdel-Meguid, S. S. &#x00026; Tsukihara, T. (1979). <italic>J. Appl. Cryst.</italic>
<bold>12</bold>, 570&#x02013;581.</mixed-citation></ref><ref id="bb24"><mixed-citation publication-type="other">Sauter, N. K. (2015). <italic>J. Synchrotron Rad.</italic>
<bold>22</bold>, 239&#x02013;248.</mixed-citation></ref><ref id="bb25"><mixed-citation publication-type="other">Sauter, N. K., Hattne, J., Brewster, A. S., Echols, N., Zwart, P. H. &#x00026; Adams, P. D. (2014). <italic>Acta Cryst.</italic> D<bold>70</bold>, 3299&#x02013;3309.</mixed-citation></ref><ref id="bb26"><mixed-citation publication-type="other">Son, S.-K. &#x00026; Santra, R. (2011). <italic>Phys. Rev. A</italic>, <bold>83</bold>, 033402.</mixed-citation></ref><ref id="bb27"><mixed-citation publication-type="other">Stellato, F. <italic>et al.</italic> (2014). <italic>IUCrJ</italic>, <bold>1</bold>, 204&#x02013;212.</mixed-citation></ref><ref id="bb28"><mixed-citation publication-type="other">Tenboer, J. <italic>et al.</italic> (2014). <italic>Science</italic>, <bold>346</bold>, 1242&#x02013;1246.</mixed-citation></ref><ref id="bb29"><mixed-citation publication-type="other">Uervirojnangkoorn, M., Zeldin, O. B., Lyubimov, A. Y., Hattne, J., Brewster, A. S., Sauter, N. K., Brunger, A. T. &#x00026; Weis, W. I. (2015). <italic>eLife</italic>, <bold>4</bold>, e05421.</mixed-citation></ref><ref id="bb30"><mixed-citation publication-type="other">White, T. A. (2014). <italic>Philos. Trans. R. Soc. London Ser. B</italic>, <bold>369</bold>, 20130330.</mixed-citation></ref><ref id="bb31"><mixed-citation publication-type="other">White, T. A., Barty, A., Stellato, F., Holton, J. M., Kirian, R. A., Zatsepin, N. A. &#x00026; Chapman, H. N. (2013). <italic>Acta Cryst.</italic> D<bold>69</bold>, 1231&#x02013;1240.</mixed-citation></ref><ref id="bb32"><mixed-citation publication-type="other">White, T. A., Kirian, R. A., Martin, A. V., Aquila, A., Nass, K., Barty, A. &#x00026; Chapman, H. N. (2012). <italic>J. Appl. Cryst.</italic>
<bold>45</bold>, 335&#x02013;341.</mixed-citation></ref><ref id="bb33"><mixed-citation publication-type="other">Yamashita, K. <italic>et al.</italic> (2015). <italic>Sci. Rep.</italic>
<bold>5</bold>, 14017.</mixed-citation></ref><ref id="bb34"><mixed-citation publication-type="other">Yefanov, O., Mariani, V., Gati, C., White, T. A., Chapman, H. N. &#x00026; Barty, A. (2015). <italic>Opt. Express</italic>, <bold>23</bold>, 28459.</mixed-citation></ref><ref id="bb35"><mixed-citation publication-type="other">Zeldin, O. B., Brewster, A. S., Hattne, J., Uervirojnangkoorn, M., Lyubimov, A. Y., Zhou, Q., Zhao, M., Weis, W. I., Sauter, N. K. &#x00026; Brunger, A. T. (2015). <italic>Acta Cryst.</italic> D<bold>71</bold>, 352&#x02013;356.</mixed-citation></ref><ref id="bb36"><mixed-citation publication-type="other">Zhang, H. <italic>et al.</italic> (2015). <italic>Cell</italic>, <bold>161</bold>, 833&#x02013;844.</mixed-citation></ref></ref-list></back><floats-group><fig id="fig1" position="float"><label>Figure 1</label><caption><p>Screenshot of <italic>cell_explorer</italic> in use, showing a first indexing run on a sample (runs 130&#x02013;139) of the previously published data for the 5-<inline-formula><inline-graphic xlink:href="j-49-00680-efi19.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> receptor (Liu <italic>et&#x000a0;al.</italic>, 2013<xref ref-type="bibr" rid="bb17"> &#x025b8;</xref>). Two alternative sets of lattice parameters, in this case with different centring types, have been found, which in this example represent the same lattice. A Gaussian function has been fitted to the distribution of <italic>a</italic> parameters, yielding a mean and standard deviation.</p></caption><graphic xlink:href="j-49-00680-fig1"/></fig><fig id="fig2" position="float"><label>Figure 2</label><caption><p>Possible layouts for image data in a &#x02018;multi-event&#x02019; HDF5 file. (<italic>a</italic>) A three-dimensional array where one direction corresponds to image data. The correspondence between the dimensions of the array and the image data/frame number axes is arbitrary and can be defined by the user. (<italic>b</italic>) A tree of HDF5 groups, where each frame contains a simple two-dimensional array. (<italic>c</italic>) A combination of the two, where the file contains multiple three-dimensional blocks, each containing many frames of data. (<italic>d</italic>) A tree of HDF5 groups where the data for each of the two detector panels are stored in separate two-dimensional arrays.</p></caption><graphic xlink:href="j-49-00680-fig2"/></fig><fig id="fig3" position="float"><label>Figure 3</label><caption><p>Separation of snapshots into clusters when resolving an indexing ambiguity on the original data stream from Chapman <italic>et&#x000a0;al.</italic> (2011<xref ref-type="bibr" rid="bb6"> &#x025b8;</xref>). Orange and blue dots, respectively, show the values <italic>f</italic> and <italic>g</italic> for each crystal. The red and blue lines show the smoothed average values of <italic>f</italic> and <italic>g</italic>, respectively. The upper and lower black lines show the smoothed average values of whichever of <italic>f</italic> or <italic>g</italic> is greater or lower, respectively, for a particular crystal. The algorithm operates by considering each crystal in turn and passing over the entire dataset multiple times. Accordingly, the horizontal axis is labelled twice, once at the bottom of the graph and once at the top, to show both the number of crystals used and the number of passes over the dataset. In this run, the entire dataset (15&#x02005;445 crystals) was passed over three times, as shown in the top right.</p></caption><graphic xlink:href="j-49-00680-fig3"/></fig><fig id="fig4" position="float"><label>Figure 4</label><caption><p>Scatter plot of in-plane shifts to be applied to the entire detector, as determined by the prediction refinement procedure. A clear shift of 0.29&#x02005;mm, corresponding to 2.6 pixels for this detector, is apparent.</p></caption><graphic xlink:href="j-49-00680-fig4"/></fig><fig id="fig5" position="float"><label>Figure 5</label><caption><p>Flow diagram of processing for one frame of data within <italic>indexamajig</italic>. Several indexing methods can be tried in turn, in a user-specified order. For the purposes of illustration, the <italic>MOSFLM</italic>, <italic>DirAx</italic> and <italic>XDS</italic> methods have been selected here, with <italic>DirAx</italic> being the first to produce an indexing solution. The subsequent stages of checking and refining the result can be disabled by the user if required.</p></caption><graphic xlink:href="j-49-00680-fig5"/></fig><fig id="fig6" position="float"><label>Figure 6</label><caption><p>
<inline-formula><inline-graphic xlink:href="j-49-00680-efi18.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> values for the same SFX dataset as is shown in Figs. 1<xref ref-type="fig" rid="fig1"> &#x025b8;</xref> and 4<xref ref-type="fig" rid="fig4"> &#x025b8;</xref>, with and without prediction refinement and scaling.</p></caption><graphic xlink:href="j-49-00680-fig6"/></fig></floats-group></article>